<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* =====================================================
       üßæ E-Slip (Standard View)
       -----------------------------------------------------
       ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
       ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å /docs/receipt/:job_id)
       ‚úÖ ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤
       ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö field ‡πÉ‡∏î ‡πÜ ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
       ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ API/Controller/DB ‡πÉ‡∏î ‡πÜ
       -----------------------------------------------------
       ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß/‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° requirement 100%
       ===================================================== */

    .page{ max-width: 520px; margin: 0 auto; padding: 12px; }

    /* ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */
    .eslip{
      background:#ffffff;
      border:1px solid rgba(15,23,42,0.10);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(2,6,23,0.08);
    }
    .eslip-head{ text-align:center; }
    .eslip-head .h1{ font-weight:900; font-size:18px; }
    .eslip-head .h2{ margin-top:4px; font-weight:800; font-size:14px; color:#0f172a; }

    .eslip-meta{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .eslip-meta .box{ padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:rgba(37,99,235,0.04); }

    .eslip-table{ width:100%; border-collapse:collapse; margin-top:12px; }
    .eslip-table th,.eslip-table td{ border:1px solid rgba(15,23,42,0.10); padding:8px; font-size:13px; }
    .eslip-table th{ background: rgba(37,99,235,0.08); text-align:left; }

    .eslip-sum{ margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:#fff; }
    .eslip-sum .row{ display:flex; justify-content:space-between; gap:10px; margin:6px 0; }
    .eslip-sum .total{ font-size:18px; font-weight:900; }

    .eslip-contact{ margin-top:10px; text-align:center; color:#334155; font-size:12.5px; line-height:1.45; }

    .eslip-foot{ margin-top:12px; text-align:center; color:#475569; font-size:12.5px; line-height:1.45; }

    /* ‡∏õ‡∏∏‡πà‡∏°/‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
    .top-actions{ display:flex; gap:10px; justify-content:flex-end; margin: 6px 0 12px; }
    .top-actions button{ width:auto; }

    /* ‡∏û‡∏¥‡∏°‡∏û‡πå */
    @media print{
      .top-actions{ display:none !important; }
      body{ background:#fff; }
      .page{ max-width: none; padding: 0; }
      .eslip{ box-shadow:none; border: none; border-radius: 0; }
    }
  </style>
</head>

<body class="theme-2">
  <div class="page">
    <div class="top-actions">
      <button class="secondary" type="button" onclick="window.close()">‡∏õ‡∏¥‡∏î</button>
      <button type="button" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    </div>

    <div class="eslip" id="doc">
      <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip...</div>
    </div>
  </div>

<script>
  const API = window.location.origin;

  // ==============================
  // üîí Helper: escape HTML
  // ==============================
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[m]));
  }

  // ==============================
  // üîé Read query string
  // ==============================
  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  // ==============================
  // üßæ Parse receipt HTML (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
  // - ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
  // - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏á‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
  // ==============================
  function parseReceiptHtml(html){
    const doc = new DOMParser().parseFromString(html, "text/html");

    // 1) rows (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    const table = doc.querySelector("table");
    const rows = Array.from(table?.querySelectorAll("tbody tr") || []).map(tr => {
      const tds = Array.from(tr.querySelectorAll("td")).map(td => (td.textContent || "").trim());
      return {
        name: tds[0] || "-",
        qty: tds[1] || "-",
        unit: tds[2] || "-",
        line: tds[3] || "-",
      };
    });

    // 2) summary (‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î / ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)
    const boxes = Array.from(doc.querySelectorAll(".box"));
    const sumBox = boxes.find(b => (b.textContent || "").includes("‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")) || null;
    const sumText = (sumBox?.textContent || "").replace(/\s+/g," ").trim();

    const subtotal = (sumText.match(/‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const discount = (sumText.match(/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const total = (sumText.match(/‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:\s*([0-9,\.]+)/) || [])[1] || "-";

    // 3) customer/job meta (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:)
    const metaBox = boxes.find(b => (b.textContent || "").includes("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:")) || null;
    const metaText = (metaBox?.textContent || "").replace(/\s+/g," ").trim();

    function pick(label){
      const re = new RegExp(label + "\\s*([^\\n]+)", "i");
      const m = metaText.match(re);
      if (!m) return "-";
      return (m[1] || "-").trim();
    }

    const customerName = pick("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:");
    const customerPhone = pick("‡πÇ‡∏ó‡∏£:");
    const jobType = pick("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:");
    const appointment = pick("‡∏ô‡∏±‡∏î:");
    const address = pick("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:");

    // 4) booking (‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ title)
    const bookingBox = boxes.find(b => (b.textContent || "").includes("CWF") || (b.textContent || "").includes("‡∏á‡∏≤‡∏ô #")) || null;
    const bookingRaw = (bookingBox?.textContent || "").replace(/\s+/g," ").trim();
    const booking = bookingRaw ? bookingRaw.split(" ")[0] : "-";

    return {
      booking,
      rows: rows.length ? rows : [{name:"-",qty:"-",unit:"-",line:"-"}],
      subtotal,
      discount,
      total,
      meta: {
        customerName,
        customerPhone,
        jobType,
        appointment,
        address
      }
    };
  }

  // ==============================
  // üßæ Render E-Receipt (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏° requirement 100%)
  // ==============================
  function renderESlip(data){
    const printedAt = new Date().toLocaleString("th-TH");
    const mount = document.getElementById("doc");

    mount.innerHTML = `
      <div class="eslip-head">
        <div class="h1">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (E-Receipt)</div>
        <div class="h2">Coldwindflow Air Services</div>
      </div>

      <div class="eslip-meta">
        <div class="box"><b>Booking:</b> ${esc(data.booking || "-")}</div>
        <div class="box"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</b> ${esc(printedAt)}</div>
      </div>

      <div style="margin-top:10px;">
        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${esc(data.meta.customerName || "-")}</div>
        <div><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${esc(data.meta.customerPhone || "-")}</div>
        <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${esc(data.meta.jobType || "-")}</div>
        <div><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${esc(data.meta.appointment || "-")}</div>
        <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${esc(data.meta.address || "-")}</div>
      </div>

      <table class="eslip-table" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤">
        <thead>
          <tr>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th style="text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th style="text-align:right;">‡∏£‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody>
          ${data.rows.map(it => `
            <tr>
              <td>${esc(it.name)}</td>
              <td style="text-align:right;">${esc(it.qty)}</td>
              <td style="text-align:right;">${esc(it.unit)}</td>
              <td style="text-align:right;">${esc(it.line)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="eslip-sum">
        <div class="row"><span>‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</span><b>${esc(data.subtotal)}</b></div>
        <div class="row"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><b>${esc(data.discount)}</b></div>
        <div class="row total"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>${esc(data.total)}</span></div>
      </div>

      <div class="eslip-contact">
        ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: 23/61 ‡∏ñ.‡∏û‡∏∂‡πà‡∏á‡∏°‡∏µ 50 ‡πÅ‡∏Ç‡∏ß‡∏á‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å ‡πÄ‡∏Ç‡∏ï‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø 10260<br>
        ‡πÇ‡∏ó‡∏£: 098-877-7321 ¬∑ LINE OA: @cwfair ¬∑ ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå: www.cwf-air.com
      </div>

      <div class="eslip-foot">
        ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ<br>
        ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
      </div>
    `;
  }

  // ==============================
  // üöÄ Main
  // ==============================
  (async function main(){
    const jobId = Number(qs("job_id") || qs("id") || 0);
    const mount = document.getElementById("doc");

    if (!jobId){
      mount.innerHTML = `<div class="muted">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö job_id ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå</div>`;
      return;
    }

    // ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (receipt) ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ backend
    const receiptUrl = `${API}/docs/receipt/${encodeURIComponent(jobId)}`;

    try{
      const r = await fetch(receiptUrl, { cache: "no-store" });
      const html = await r.text();
      if (!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const parsed = parseReceiptHtml(html);
      renderESlip(parsed);
    }catch(e){
      mount.innerHTML = `<div class="muted">‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${esc(e.message || e)}</div>`;
    }
  })();
</script>
</body>
</html>
