<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="/mainfest.json">
  <meta name="theme-color" content="#0b4bb3">
</head>
<body class="theme-2 customer-page">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
          <span class="muted">Coldwindflow air services</span>
        </div>
      </div>
      <div class="top-actions">
        <div id="auth_box" class="auth-box">
          <a id="line_login_btn" class="secondary link-btn" href="/auth/line">‚úÖ Login ‡∏î‡πâ‡∏ß‡∏¢ LINE</a>
          <a id="register_btn" class="secondary link-btn" style="display:none;" href="/register">üìç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</a>
          <div id="me_badge" class="me-badge" style="display:none;">
            <img id="me_pic" alt="" class="me-pic">
            <b id="me_name" class="me-name"></b>
          </div>
        </div>
        <button class="secondary top-track" type="button" onclick="location.href='/track.html'">üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <!-- OPTIONAL-6: Trust signals (minimal + no regression) -->
    <div class="trust-bar">
      <div class="trust-pills">
        <span class="trust-pill">‚úÖ ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
        <span class="trust-pill">üõ°Ô∏è ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏á‡∏≤‡∏ô</span>
        <span class="trust-pill">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ</span>
        <span class="trust-pill">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ LINE OA</span>
      </div>
      <div class="trust-actions">
        <a class="trust-btn phone" href="tel:0988777321">üìû ‡πÇ‡∏ó‡∏£‡πÄ‡∏•‡∏¢</a>
        <a class="trust-btn line" href="https://line.me/R/ti/p/@cwfair" target="_blank" rel="noopener">üí¨ ‡πÅ‡∏ä‡∏ó‡πÑ‡∏•‡∏ô‡πå</a>
      </div>
    </div>

    
    <div class="card service-card">
      <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>

      <div class="service-grid">
        <select id="job_type">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á">‡∏•‡πâ‡∏≤‡∏á</option>
          <option value="‡∏ã‡πà‡∏≠‡∏°">‡∏ã‡πà‡∏≠‡∏°</option>
          <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</option>
        </select>

        <div class="grid2">
          <select id="ac_type">
            <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå --</option>
            <option value="‡∏ú‡∏ô‡∏±‡∏á">‡∏ú‡∏ô‡∏±‡∏á (Wall Type)</option>
            <option value="‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á">‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</option>
            <option value="‡πÅ‡∏Ç‡∏ß‡∏ô">‡πÅ‡∏Ç‡∏ß‡∏ô</option>
            <option value="‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤">‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤</option>
          </select>
          <select id="btu">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BTU</option>
            <option value="9000">9,000</option>
            <option value="12000">12,000</option>
            <option value="15000">15,000</option>
            <option value="18000">18,000</option>
            <option value="24000">24,000</option>
            <option value="30000">30,000</option>
            <option value="36000">36,000</option>
            <option value="48000">48,000</option>
            <option value="60000">60,000</option>
          </select>
        </div>

        <div class="grid2" style="align-items:start;">
          <div class="machine-box">
            <div class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</div>
            <input id="machine_count" type="hidden" value="1">
            <div class="stepper" aria-label="machine count" style="margin-top:8px;">
              <button id="mc_minus" class="btn-round" type="button" aria-label="‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">‚àí</button>
              <div id="mc_value" class="value">1</div>
              <button id="mc_plus" class="btn-round" type="button" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">+</button>
            </div>
            <div class="muted" style="font-size:12px;margin-top:6px;">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
          </div>

          <div class="urgent-card">
            <label style="display:flex;align-items:flex-start;gap:10px;">
              <input id="urgent_toggle" type="checkbox" style="transform:scale(1.2);margin-top:2px;">
              <div>
                <b>‡πÇ‡∏´‡∏°‡∏î‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</b>
                <div class="muted" style="margin-top:2px;">‡∏¢‡∏¥‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö (‡∏≠‡∏≤‡∏à‡∏£‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ)</div>
              </div>
            </label>
          </div>
        </div>

        <select id="wash_variant" style="margin-top:8px;display:none;">
          <option value="‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤">‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°">‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏•‡πå</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á">‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà</option>
        </select>

        <select id="repair_variant" style="margin-top:8px;display:none;">
          <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (500)</option>
          <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏±‡πà‡∏ß">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏±‡πà‡∏ß (1000)</option>
          <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</option>
        </select>

        <div class="estimate-bar">
          <div class="estimate-left">
            <div class="estimate-title">üíµ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
            <div class="estimate-sub muted">* ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‚Äù ‡∏≠‡∏≤‡∏à‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô</div>
          </div>
          <div class="estimate-right">
            <div class="estimate-amt"><span id="grand_total">0</span> ‡∏ö‡∏≤‡∏ó</div>
            <div class="estimate-duration">‚è±Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: <b><span id="duration_min">-</span></b> ‡∏ô‡∏≤‡∏ó‡∏µ</div>
          </div>
        </div>

        <!-- keep these ids for existing logic (hidden but used) -->
        <div style="display:none;">
          <span id="standard_price">-</span>
        </div>

        <div class="promo-card">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
            <b>üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</b>
            <select id="promotion_select_customer" style="width:auto;min-width:220px;"></select>
          </div>
          <div class="muted" style="margin-top:6px;">* ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</h2>

      <div class="grid2">
        <input id="date" type="date">
        <button id="loadSlotsBtn" type="button" onclick="loadSlots()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</button>
      </div>

      <div id="slot_controls" class="slot-controls" style="margin-top:12px;display:none;">
        <div class="chip-group" role="tablist" aria-label="slot filter">
          <button id="filter_avail" type="button" class="chip active" aria-selected="true">‚úÖ ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</button>
          <button id="filter_all" type="button" class="chip" aria-selected="false">üìÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px;">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏î‡πâ‡∏ß‡∏¢</div>
      </div>

      <div id="slots" class="muted" style="margin-top:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‚Äù</div>

      <div class="picked-row">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <b id="picked">-</b></div>

      <div class="divider"></div>

      <h2 style="margin-top:0;">3) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h2>

      <div class="grid2">
        <input id="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input id="customer_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>

      <input id="address_text" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)">

      <div class="maps-field">
        <input id="maps_url" type="url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á" autocomplete="off">
        <div class="maps-helper-row">
          <button id="maps_help_btn" class="linkish" type="button">üó∫Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
          <div id="maps_hint" class="muted" style="font-size:12px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö maps.app.goo.gl ‡πÅ‡∏•‡∏∞ google.com/maps</div>
        </div>
        <div id="maps_pop" class="maps-pop" style="display:none;">
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</b>
          <div class="muted" style="margin-top:4px;">
            ‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‚Üí ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏Å‡∏î ‚Äú‡πÅ‡∏ä‡∏£‡πå‚Äù ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Üí ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
          </div>
        </div>
        <div id="maps_preview" class="maps-preview" style="display:none;"></div>
      </div>

      <textarea id="customer_note" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>

      <!-- Summary card before confirm -->
      <div id="confirm_summary" class="summary-card" style="margin-top:12px;">
        <div class="summary-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="k">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div class="v" id="sum_datetime">-</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
            <div class="v" id="sum_service">-</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</div>
            <div class="v" id="sum_price">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="v" id="sum_location">-</div>
          </div>
        </div>
      </div>

      <button id="confirm_btn" type="button" class="primary-cta" onclick="book()" style="margin-top:12px;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á</button>

      <div id="result" class="muted" style="margin-top:10px;"></div>
    </div>

  </div>


<script>
const API = window.location.origin;

async function loadMe(){
  try{
    const r = await fetch(`${API}/public/me`, { credentials: 'include' });
    const j = await r.json().catch(()=>({logged_in:false}));
    const loginBtn = document.getElementById('line_login_btn');
    const regBtn = document.getElementById('register_btn');
    const badge = document.getElementById('me_badge');
    const pic = document.getElementById('me_pic');
    const name = document.getElementById('me_name');
    if(j && j.logged_in){
      if(loginBtn) loginBtn.style.display = 'none';
      if(regBtn) regBtn.style.display = 'inline-flex';
      if(badge) badge.style.display = 'inline-flex';
      if(name) name.textContent = (j.user && j.user.name) ? j.user.name : 'Logged in';
      if(pic) {
        const u = (j.user && j.user.picture) ? j.user.picture : '';
        if(u){ pic.src = u; pic.style.display='block'; }
        else { pic.style.display='none'; }
      }
    }else{
      if(loginBtn) loginBtn.style.display = 'inline-flex';
      if(regBtn) regBtn.style.display = 'none';
      if(badge) badge.style.display = 'none';
    }
  }catch(_){
    // ignore
  }
}

function showTopNoticeFromUrl(){
  try{
    const p = new URLSearchParams(location.search || '');
    const v = String(p.get('register') || '').trim();
    if(!v) return;
    const el = document.getElementById('result');
    if(!el) return;
    if(v === 'success') {
      el.innerHTML = '<div class="card" style="padding:12px;border:1px solid rgba(15,23,42,0.12);">‚úÖ <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b><div class="muted" style="margin-top:4px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div></div>';
    } else if(v === 'need_login') {
      el.innerHTML = '<div class="card" style="padding:12px;border:1px solid rgba(15,23,42,0.12);">‚ö†Ô∏è <b>‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô</b><div class="muted" style="margin-top:4px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î Login ‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î Register</div></div>';
    }
  } catch(_) {}
}

let pickedTime = null;
let standardPrice = 0;
let durationMin = 60;

// Slot filter (default: available only)
let slotFilterMode = 'avail'; // 'avail' | 'all'
let lastSlotsResp = null;     // cache last availability response

// PATCH: machine count stepper
function bindMachineCountStepper(){
  const input = document.getElementById('machine_count');
  const val = document.getElementById('mc_value');
  const minus = document.getElementById('mc_minus');
  const plus = document.getElementById('mc_plus');
  if(!input || !val || !minus || !plus) return;
  const set = async (n)=>{
    const v = Math.max(1, Math.min(10, Number(n)||1));
    input.value = String(v);
    val.textContent = String(v);
    showVariantFields();
    await refreshPricing();
    updateLoadSlotsEnabled();
  };
  minus.addEventListener('click', ()=> set(Number(input.value||1)-1));
  plus.addEventListener('click', ()=> set(Number(input.value||1)+1));
  set(input.value||1);
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏≠‡∏ï: ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" (UX ‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏õ‡∏ó‡∏≥‡πÉ‡∏ô loadSlots() ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û
function isBookingFormReadyForSlots() {
  const d = document.getElementById("date")?.value;
  return !!d;
}

function updateLoadSlotsEnabled() {
  const btn = document.getElementById("loadSlotsBtn");
  if (!btn) return;
  btn.disabled = !isBookingFormReadyForSlots();
}

// extras + promo (customer)
let catalogItemsCustomer = [];
let promotionsCustomer = [];
let selectedItemsCustomer = []; // {item_id,item_name,qty,unit_price}

function calcDiscount(subtotal, promo) {
  if (!promo) return 0;
  const v = Number(promo.promo_value || 0);
  if (promo.promo_type === "percent") return subtotal * (Math.max(0, v) / 100);
  if (promo.promo_type === "amount") return Math.max(0, v);
  return 0;
}

function getSelectedPromoCustomer() {
  const promoId = document.getElementById("promotion_select_customer")?.value || "";
  return promotionsCustomer.find(p => String(p.promo_id) === String(promoId)) || null;
}

function recomputeGrandTotal() {
  const extrasSubtotal = selectedItemsCustomer.reduce((sum, it) => sum + (Number(it.qty) * Number(it.unit_price)), 0);
  const subtotal = Number(standardPrice || 0) + extrasSubtotal;
  const promo = getSelectedPromoCustomer();
  const discount = Math.min(subtotal, calcDiscount(subtotal, promo));
  const total = Math.max(0, subtotal - discount);
  const totalBox = document.getElementById("grand_total");
  if (totalBox) totalBox.textContent = total.toFixed(0);

  // keep summary always up-to-date
  updateConfirmSummary();
}

function updateConfirmSummary(){
  const d = document.getElementById('date')?.value || '';
  const time = pickedTime || '';
  const dt = document.getElementById('sum_datetime');
  if(dt) dt.textContent = (d && time) ? `${d} ‚Ä¢ ${time}` : '-';

  const payload = getPayloadV2();
  const parts = [];
  if(payload.job_type) parts.push(payload.job_type);
  if(payload.ac_type) parts.push(payload.ac_type);
  if(payload.btu) parts.push(`${payload.btu.toLocaleString('th-TH')} BTU`);
  if(payload.machine_count) parts.push(`${payload.machine_count} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á`);
  if(payload.job_type === '‡∏•‡πâ‡∏≤‡∏á' && payload.wash_variant) parts.push(payload.wash_variant);
  if(payload.job_type === '‡∏ã‡πà‡∏≠‡∏°' && payload.repair_variant) parts.push(payload.repair_variant);
  const svc = document.getElementById('sum_service');
  if(svc) svc.textContent = parts.length ? parts.join(' ‚Ä¢ ') : '-';

  const price = document.getElementById('sum_price');
  const gt = document.getElementById('grand_total')?.textContent || '0';
  if(price){
    const n = Number(gt || 0);
    price.textContent = n > 0 ? `${n.toFixed(0)} ‡∏ö‡∏≤‡∏ó (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)` : '‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£';
  }

  const addr = (document.getElementById('address_text')?.value || '').trim();
  const map = (document.getElementById('maps_url')?.value || '').trim();
  const loc = document.getElementById('sum_location');
  if(loc){
    if(!addr && !map) loc.textContent = '-';
    else {
      const a = addr ? addr : '';
      const m = map ? '‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà' : '';
      loc.innerHTML = `${escapeHtml(a)}${(a && m) ? '<br>' : ''}${m ? `<a href="${escapeAttr(map)}" target="_blank" rel="noopener">üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>` : ''}`;
    }
  }
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[c]));
}
function escapeAttr(s){
  return String(s||'').replace(/"/g,'&quot;');
}

function isValidMapsUrl(u){
  if(!u) return false;
  try{
    const url = new URL(u);
    const h = (url.hostname||'').toLowerCase();
    const p = (url.pathname||'');
    // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
    if(h === 'maps.app.goo.gl' || h.endsWith('.app.goo.gl')) return true;
    if(h === 'www.google.com' || h === 'google.com'){
      return p.startsWith('/maps') || url.searchParams.has('q') || url.searchParams.has('query');
    }
    if(h === 'goo.gl' && p.includes('maps')) return true;
    return false;
  }catch(_){
    return false;
  }
}

function updateMapsPreview(){
  const el = document.getElementById('maps_url');
  const box = document.getElementById('maps_preview');
  const hint = document.getElementById('maps_hint');
  if(!el || !box) return;
  const v = (el.value||'').trim();
  if(!v){
    box.style.display = 'none';
    box.innerHTML = '';
    if(hint){ hint.textContent = '‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö maps.app.goo.gl ‡πÅ‡∏•‡∏∞ google.com/maps'; hint.classList.remove('warn'); }
    return;
  }
  const ok = isValidMapsUrl(v);
  if(hint){
    hint.textContent = ok ? '‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏π‡πÇ‡∏≠‡πÄ‡∏Ñ ‚úÖ' : '‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Maps (‡∏¢‡∏±‡∏á‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ)';
    hint.classList.toggle('warn', !ok);
  }
  box.style.display = 'block';
  box.innerHTML = ok
    ? `<a class="secondary" style="width:auto;min-height:40px;padding:10px 12px;display:inline-flex;align-items:center;gap:8px;text-decoration:none;" href="${escapeAttr(v)}" target="_blank" rel="noopener">üìç ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>`
    : `<div class="inline-warn">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å Google Maps ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏∏‡∏î</div>`;
}

function renderItemsCustomer() {
  const box = document.getElementById("items_preview_customer");
  if (!box) return;
  if (!selectedItemsCustomer.length) {
    box.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
    recomputeGrandTotal();
    return;
  }
  const rows = selectedItemsCustomer.map((it, idx) => {
    const line = Number(it.qty) * Number(it.unit_price);
    return `
      <div style="padding:8px;border:1px solid rgba(15,23,42,0.10);border-radius:10px;margin-bottom:8px;">
        <b>${it.item_name}</b><div class="muted">‡∏£‡∏ß‡∏°: ${line.toFixed(0)} ‡∏ö‡∏≤‡∏ó</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px;flex-wrap:wrap;">
          <label class="muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
          <input type="number" min="1" step="1" value="${it.qty}" style="width:90px;" onchange="updateQtyCustomer(${idx}, this.value)">
          <button type="button" class="danger" style="width:auto;min-height:40px;" onclick="removeItemCustomer(${idx})">‡∏•‡∏ö</button>
        </div>
      </div>
    `;
  }).join("");
  box.innerHTML = rows;
  recomputeGrandTotal();
}

function addItemCustomer() {
  const sel = document.getElementById("catalog_select_customer");
  const qtyEl = document.getElementById("item_qty_customer");
  const id = Number(sel?.value || 0);
  const qty = Math.max(1, Number(qtyEl?.value || 1));
  if (!id) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
  const found = catalogItemsCustomer.find(x => Number(x.item_id) === id);
  if (!found) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
  const existed = selectedItemsCustomer.find(x => Number(x.item_id) === id);
  if (existed) existed.qty += qty;
  else selectedItemsCustomer.push({ item_id: found.item_id, item_name: found.item_name, qty, unit_price: Number(found.base_price || 0) });
  renderItemsCustomer();
}
function updateQtyCustomer(idx, val) {
  selectedItemsCustomer[idx].qty = Math.max(1, Number(val || 1));
  renderItemsCustomer();
}
function removeItemCustomer(idx) {
  selectedItemsCustomer.splice(idx, 1);
  renderItemsCustomer();
}

function getPayloadV2(){
  const job_type = document.getElementById("job_type").value.trim();
  const ac_type = document.getElementById("ac_type").value.trim();
  const btu = Number(document.getElementById("btu").value || 0);
  const machine_count = Math.max(1, Number(document.getElementById("machine_count").value || 1));
  const wash_variant = document.getElementById("wash_variant").value.trim();
  const repair_variant = document.getElementById("repair_variant").value.trim();
  return { job_type, ac_type, btu, machine_count, wash_variant, repair_variant };
}

function showVariantFields(){
  const job_type = document.getElementById("job_type").value.trim();
  const wash = document.getElementById("wash_variant");
  const rep = document.getElementById("repair_variant");
  wash.style.display = job_type === "‡∏•‡πâ‡∏≤‡∏á" ? "block" : "none";
  rep.style.display = job_type === "‡∏ã‡πà‡∏≠‡∏°" ? "block" : "none";
}

async function refreshPricing(){
  const payload = getPayloadV2();
  const sp = document.getElementById("standard_price");
  const dm = document.getElementById("duration_min");

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô ‚Üí reset
  if(!payload.job_type){
    standardPrice = 0; durationMin = 60;
    sp.textContent = "-"; dm.textContent = "-";
    return;
  }

  try{
    const r = await fetch(`${API}/public/pricing_preview`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    standardPrice = Number(data.standard_price || 0);
    durationMin = Number(data.duration_min || 60);

    sp.textContent = standardPrice.toFixed(0);
    dm.textContent = durationMin.toFixed(0);
  }catch(e){
    // ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà/‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Üí ‡πÅ‡∏™‡∏î‡∏á - ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)
    standardPrice = 0; durationMin = 60;
    sp.textContent = "-";
    dm.textContent = "-";
    console.warn(e);
  } finally {
    recomputeGrandTotal();
  }
}

function setPicked(time){
  pickedTime = time;
  document.getElementById("picked").textContent = time || "-";
  // toggle selected style (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload)
  document.querySelectorAll('#slots .slot-chip').forEach(b=>b.classList.remove('selected'));
  if (time) {
    const btn = Array.from(document.querySelectorAll('#slots .slot-chip')).find(b=> String(b.dataset.start||'') === String(time));
    if (btn) btn.classList.add('selected');
  }
  updateConfirmSummary();
}

function setSlotFilterMode(mode){
  slotFilterMode = (mode === 'all') ? 'all' : 'avail';
  const a = document.getElementById('filter_avail');
  const b = document.getElementById('filter_all');
  if(a && b){
    const isAvail = slotFilterMode === 'avail';
    a.classList.toggle('active', isAvail);
    b.classList.toggle('active', !isAvail);
    a.setAttribute('aria-selected', isAvail ? 'true' : 'false');
    b.setAttribute('aria-selected', !isAvail ? 'true' : 'false');
  }
  if(lastSlotsResp) renderSlotsFromCache();
}

function renderSlotsFromCache(){
  const slotsBox = document.getElementById('slots');
  if(!slotsBox || !lastSlotsResp) return;
  const data = lastSlotsResp;
  const slotsAll = (data.slots || []).filter(Boolean);
  const slotsAvail = slotsAll.filter(s=>!!s.available);
  const list = (slotFilterMode === 'all') ? slotsAll : slotsAvail;

  // if current picked time is filtered out ‚Üí reset
  if(pickedTime && !list.some(s=>String(s.start)===String(pickedTime))) setPicked(null);

  const head = `<div class="slot-head">
    <div class="muted">‡πÇ‡∏´‡∏°‡∏î: <b>${data.tech_type==='partner'?'‡∏î‡πà‡∏ß‡∏ô (‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)':'‡∏õ‡∏Å‡∏ï‡∏¥'}</b> ‚Ä¢ ‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤: ${data.tech_count} ‡∏Ñ‡∏ô</div>
    <div class="badge ${slotsAvail.length? 'ok':'muted'}">${slotsAvail.length? '‡∏ß‡πà‡∏≤‡∏á':'‡πÄ‡∏ï‡πá‡∏°'} ‚Ä¢ ${slotsAvail.length}/${slotsAll.length}</div>
  </div>`;

  if(!list.length){
    slotsBox.innerHTML = head + `<div class="muted" style="margin-top:10px;">${slotFilterMode==='avail' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'}</div>`;
    return;
  }

  const chips = list.map(s=>{
    const techCount = Array.isArray(s.available_tech_ids) ? s.available_tech_ids.length : 0;
    const full = !s.available;
    const cls = `slot-chip ${s.available? 'is-available':'is-full'} ${pickedTime===s.start? 'selected':''}`;
    const disabled = full ? 'disabled' : '';
    const meta = s.available ? `‡∏ß‡πà‡∏≤‡∏á ‚Ä¢ ${techCount} ‡∏ä‡πà‡∏≤‡∏á` : '‡πÄ‡∏ï‡πá‡∏°';
    return `<button type="button" class="${cls}" data-start="${s.start}" ${disabled} onclick="setPicked('${s.start}')">
      <span class="t">${s.start}</span>
      <span class="m">${meta}</span>
    </button>`;
  }).join('');

  slotsBox.innerHTML = head + `<div class="slot-chip-wrap" style="margin-top:10px;">${chips}</div>`;
}

async function loadSlots(){
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  setPicked(null);

  const slotsBox = document.getElementById("slots");
  const controls = document.getElementById('slot_controls');
  if(controls) controls.style.display = 'none';
  slotsBox.innerHTML = `<div class="slot-skeleton">
    <div class="sk-line"></div>
    <div class="sk-chips">
      ${Array.from({length:10}).map(()=>'<div class="sk-chip"></div>').join('')}
    </div>
  </div>`;

  const payload = getPayloadV2();
  // ‚úÖ ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á
  if (!payload.job_type || !payload.ac_type || !payload.btu || !payload.machine_count) {
    slotsBox.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå / BTU / ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡∏Å‡πà‡∏≠‡∏ô";
    return;
  }
  if (payload.job_type === "‡∏•‡πâ‡∏≤‡∏á" && !payload.wash_variant) {
    slotsBox.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô";
    return;
  }
  if (payload.job_type === "‡∏ã‡πà‡∏≠‡∏°" && !payload.repair_variant) {
    slotsBox.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô";
    return;
  }

  await refreshPricing(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï durationMin ‡∏Å‡πà‡∏≠‡∏ô

  const duration_min = Number(durationMin || 60);
  const urgent = document.getElementById("urgent_toggle").checked;
  const tech_type = urgent ? "partner" : "company";

  const url = `${API}/public/availability_v2?date=${encodeURIComponent(d)}&tech_type=${encodeURIComponent(tech_type)}&duration_min=${encodeURIComponent(duration_min)}`;

  fetch(url)
    .then(r=>r.json())
    .then(data=>{
      if(data.error) throw new Error(data.error);
      if(!data.slots || !data.slots.length){
        slotsBox.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
        return;
      }

      // cache + render with filter
      lastSlotsResp = data;
      if(controls) controls.style.display = 'block';
      renderSlotsFromCache();
    })
    .catch(e=>{
      slotsBox.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
      console.error(e);
    });
}

async function book(){
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  if(!pickedTime) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô");

  const customer_name = document.getElementById("customer_name").value.trim();
  const customer_phone = document.getElementById("customer_phone").value.trim();
  const job_type = document.getElementById("job_type").value.trim();
  const address_text = document.getElementById("address_text").value.trim();
  const maps_url = document.getElementById("maps_url").value.trim();
  const customer_note = document.getElementById("customer_note").value.trim();

  // ‚úÖ ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ñ‡πâ‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Maps (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á)
  if(maps_url && !isValidMapsUrl(maps_url)){
    toast('‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Maps (‡∏¢‡∏±‡∏á‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ)');
  }

  if(!customer_name || !job_type || !address_text){
    return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)");
  }

  const appointment_datetime = `${d}T${pickedTime}:00`;

  const payload = getPayloadV2();
  const urgent = document.getElementById("urgent_toggle").checked;

  const body = {
    customer_name, customer_phone, job_type,
    appointment_datetime, address_text, maps_url, customer_note,
    booking_mode: urgent ? "urgent" : "scheduled",
    items: selectedItemsCustomer.map(x => ({ item_id: x.item_id, qty: x.qty })),
    promotion_id: (document.getElementById("promotion_select_customer")?.value || null) || null,
    ...payload
  };

  const confirmBtn = document.getElementById('confirm_btn');
  if(confirmBtn){ confirmBtn.disabled = true; confirmBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...'; }

  fetch(`${API}/public/book`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  })
  .then(async r=>{
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return data;
  })
  .then(data=>{
    const box = document.getElementById("result");
    const token = data.token;
    const code = data.booking_code || token || '';
    const trackUrl = `${API}/track.html?q=${encodeURIComponent(code)}`;
    box.innerHTML = `<div class="success-card">
      <div class="success-title">‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      <div class="success-row"><span class="k">‡πÄ‡∏•‡∏Ç Booking/Tracking</span><span class="v"><b style="font-size:18px;">${code || '-'}</b></span></div>
      <div class="success-row"><span class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="v">${data.booking_mode==='urgent' ? '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span></div>
      <div class="success-row"><span class="k">‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span><span class="v">${data.duration_min || '-'} ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
      <div class="success-actions">
        <button type="button" class="secondary action-btn" onclick="copyText('${code.replace(/'/g,"\\'")}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç</button>
        <button type="button" class="secondary action-btn" onclick="shareLine('${code.replace(/'/g,"\\'")}')">üí¨ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE</button>
        <button type="button" class="secondary action-btn" onclick="downloadIcsForBooking()">üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
        <button type="button" class="secondary action-btn" onclick="location.href='${trackUrl}'">üîé ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>`;

    // stash for calendar button (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö flow ‡πÄ‡∏î‡∏¥‡∏°)
    window.__lastBookingForIcs = {
      code,
      date: document.getElementById('date')?.value || '',
      time: pickedTime || '',
      duration_min: Number(data.duration_min || durationMin || 60),
      address: (document.getElementById('address_text')?.value || '').trim(),
      maps_url: (document.getElementById('maps_url')?.value || '').trim(),
      track_url: trackUrl
    };
  })
  .catch(e=>{
    alert(`‚ùå ${e.message}`);
  })
  .finally(()=>{
    if(confirmBtn){ confirmBtn.disabled = false; confirmBtn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á'; }
  });
}

async function copyText(t){
  try{
    if(!t) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(String(t));
    } else {
      const ta = document.createElement('textarea');
      ta.value = String(t);
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
    toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }catch(_){
    toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.classList.add('show'), 10);
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 250); }, 1600);
}

function shareLine(code){
  try{
    const c = String(code||'').trim();
    if(!c) return;
    const trackUrl = `${API}/track.html?q=${encodeURIComponent(c)}`;
    const msg = `‡πÄ‡∏•‡∏Ç Booking: ${c}\n‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô: ${trackUrl}`;
    // ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (LINE app ‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠)
    const u = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
    window.open(u, '_blank', 'noopener');
  }catch(_){
    toast('‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function toIcsDate(dt){
  // dt = Date object (local). format: YYYYMMDDTHHMMSS
  const pad = (n)=> String(n).padStart(2,'0');
  return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
}

function downloadIcsForBooking(){
  try{
    const b = window.__lastBookingForIcs;
    if(!b || !b.date || !b.time){
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢');
      return;
    }
    const [hh, mm] = String(b.time).split(':').map(x=>Number(x||0));
    const start = new Date(`${b.date}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
    const end = new Date(start.getTime() + (Number(b.duration_min||60) * 60000));
    const uid = `CWF-${String(b.code||'').replace(/\s+/g,'')}-${Date.now()}@cwf-air.com`;
    const title = `CWF ‡∏ô‡∏±‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (${b.code||'Booking'})`;
    const loc = (b.address||'') + (b.maps_url ? ` (${b.maps_url})` : '');
    const desc = `‡πÄ‡∏•‡∏Ç Booking: ${b.code||''}\n‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô: ${b.track_url||''}`;
    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//CWF//Booking//TH',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${toIcsDate(new Date())}`,
      `DTSTART:${toIcsDate(start)}`,
      `DTEND:${toIcsDate(end)}`,
      `SUMMARY:${title}`,
      `LOCATION:${loc.replace(/\n/g,' ')}`,
      `DESCRIPTION:${desc.replace(/\n/g,'\\n')}`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\r\n');
    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CWF-${String(b.code||'booking')}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
    toast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }catch(_){
    toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

// listeners
["job_type","ac_type","btu","wash_variant","repair_variant"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("change", async ()=>{
    showVariantFields();
    await refreshPricing();
    updateLoadSlotsEnabled();
  });
});
document.getElementById("urgent_toggle").addEventListener("change", ()=>{ /* slots refresh optional */ });
document.getElementById("date").addEventListener("change", ()=>{ updateLoadSlotsEnabled(); });

async function initCustomerCatalogAndPromos(){
  try{
    const [catR, proR] = await Promise.all([
      fetch(`${API}/catalog/items?customer=1`).then(r=>r.json()).catch(()=>[]),
      fetch(`${API}/promotions?customer=1`).then(r=>r.json()).catch(()=>[]),
    ]);
    catalogItemsCustomer = Array.isArray(catR) ? catR : (catR.items || []);
    promotionsCustomer = Array.isArray(proR) ? proR : (proR.promotions || []);

    const sel = document.getElementById("catalog_select_customer");
    if (sel) {
      sel.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>` +
        catalogItemsCustomer.map(it => `<option value="${it.item_id}">${it.item_name} (${Number(it.base_price||0)} ‡∏ö‡∏≤‡∏ó)</option>`).join("");
    }
    const ps = document.getElementById("promotion_select_customer");
    if (ps) {
      ps.innerHTML = `<option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£ --</option>` +
        promotionsCustomer.map(p => {
          const label = p.promo_type === "percent" ? `-${Number(p.promo_value)}%` : `-${Number(p.promo_value)} ‡∏ö‡∏≤‡∏ó`;
          return `<option value="${p.promo_id}">${p.promo_name} (${label})</option>`;
        }).join("");
      ps.addEventListener("change", ()=> recomputeGrandTotal());
    }
  }catch(e){
    console.warn("initCustomerCatalogAndPromos", e);
  }
}

showVariantFields();
bindMachineCountStepper();
initCustomerCatalogAndPromos();
refreshPricing();
renderItemsCustomer();
updateLoadSlotsEnabled();

// slot filter controls
document.getElementById('filter_avail')?.addEventListener('click', ()=> setSlotFilterMode('avail'));
document.getElementById('filter_all')?.addEventListener('click', ()=> setSlotFilterMode('all'));
setSlotFilterMode('avail');

// keep summary fresh when user types
['date','customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', ()=> updateConfirmSummary());
});

// maps helper + preview
document.getElementById('maps_help_btn')?.addEventListener('click', ()=>{
  const pop = document.getElementById('maps_pop');
  if(!pop) return;
  pop.style.display = (pop.style.display === 'none' || !pop.style.display) ? 'block' : 'none';
});
document.getElementById('maps_url')?.addEventListener('input', ()=> updateMapsPreview());
document.addEventListener('click', (e)=>{
  const pop = document.getElementById('maps_pop');
  const btn = document.getElementById('maps_help_btn');
  if(!pop || !btn) return;
  if(pop.style.display !== 'none' && !pop.contains(e.target) && !btn.contains(e.target)) pop.style.display = 'none';
});
updateMapsPreview();
updateConfirmSummary();

// OPTIONAL-7: remember me (safe draft) ‚Äî only basic fields, no impact on booking flow
const CWF_FORM_DRAFT_KEY = 'cwf_customer_form_draft_v1';
function loadFormDraft(){
  try{
    const raw = localStorage.getItem(CWF_FORM_DRAFT_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    const ids = ['customer_name','customer_phone','address_text','maps_url','customer_note'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà user ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å
      if(!String(el.value||'').trim() && typeof d[id] === 'string') el.value = d[id];
    });
  }catch(e){ /* ignore */ }
}
let _draftTimer = null;
function saveFormDraft(){
  try{
    const d = {};
    ['customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) d[id] = String(el.value||'');
    });
    localStorage.setItem(CWF_FORM_DRAFT_KEY, JSON.stringify(d));
  }catch(e){ /* ignore */ }
}
function scheduleSaveDraft(){
  clearTimeout(_draftTimer);
  _draftTimer = setTimeout(saveFormDraft, 350);
}
['customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('input', scheduleSaveDraft);
    el.addEventListener('change', scheduleSaveDraft);
  }
});
window.addEventListener('beforeunload', ()=>{ try{ saveFormDraft(); }catch(e){} });
loadFormDraft();
updateMapsPreview(); // refresh preview after autofill
updateConfirmSummary();

loadMe();
showTopNoticeFromUrl();

// PWA update toast (‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
function showSwToast(onUpdate){
  const wrap = document.getElementById('sw_toast');
  if(!wrap) return;
  wrap.classList.add('show');
  const btn = document.getElementById('sw_toast_reload');
  const close = document.getElementById('sw_toast_close');
  if(btn){ btn.onclick = ()=>{ try{ onUpdate(); }catch(e){} }; }
  if(close){ close.onclick = ()=> wrap.classList.remove('show'); }
}

// PWA: register service worker (HTTPS only)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js').then((reg)=>{
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ worker ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠ activate ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      function promptUpdate(worker){
        if(!worker) return;
        showSwToast(()=>{
          try{ worker.postMessage({type:'SKIP_WAITING'}); }catch(e){}
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å SW ‡πÉ‡∏´‡∏°‡πà activate ‡πÅ‡∏•‡πâ‡∏ß
          setTimeout(()=>location.reload(), 400);
        });
      }

      if(reg.waiting){
        promptUpdate(reg.waiting);
      }
      reg.addEventListener('updatefound', ()=>{
        const newWorker = reg.installing;
        if(!newWorker) return;
        newWorker.addEventListener('statechange', ()=>{
          if(newWorker.state === 'installed' && navigator.serviceWorker.controller){
            promptUpdate(newWorker);
          }
        });
      });
    }).catch(()=>{});
  });
}
</script>

<div id="sw_toast" class="sw-toast" aria-live="polite">
  <div class="sw-toast-card">
    <div class="sw-toast-text">
      <strong>‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà</strong>
      <span>‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
    </div>
    <div class="sw-toast-actions">
      <button id="sw_toast_reload" class="sw-toast-btn primary" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="sw_toast_close" class="sw-toast-btn ghost" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

</body>
</html>
