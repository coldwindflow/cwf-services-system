<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="theme-2">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
          <span class="muted">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button"
        onclick="location.href='/customer.html'">üìÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
    </div>

    <div class="card">
      <div class="grid2">
        <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô CWF0000123 ‡∏´‡∏£‡∏∑‡∏≠ token" />
        <button type="button" onclick="track()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="muted" style="margin-top:8px;">* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>üìå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h2>
      <div id="result" class="muted" style="margin-top:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    </div>
  </div>

<script>
const API = window.location.origin;

function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

function statusBadge(st){
  const s = String(st||"").trim();
  if(s==="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£") return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
  if(s==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥") return '<span class="badge run">üõ†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>';
  if(s==="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß") return '<span class="badge ok">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
  if(s==="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") return '<span class="badge bad">‚õî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
  return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
}

// ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å timestamps ‡∏à‡∏£‡∏¥‡∏á)
function derivedStatus(d){
  const s = String(d.job_status || '').trim();
  if (s === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
  if (s === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
  if (d.started_at) return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
  if (d.checkin_at) return '‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
  if (d.travel_started_at) return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  return '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô';
}

function timelineHTML(d){
  const steps = [
    { k: 'accepted', label: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô / ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', ok: !!d.technician },
    { k: 'travel', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', ok: !!d.travel_started_at },
    { k: 'checkin', label: '‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)', ok: !!d.checkin_at },
    { k: 'start', label: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', ok: !!d.started_at },
    { k: 'done', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', ok: String(d.job_status||'').trim()==='‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' },
  ];
  return `
    <div class="card tight" style="margin-top:10px;">
      <b>üìç ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</b>
      <div class="muted" style="margin-top:6px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${derivedStatus(d)}</b></div>
      <ul style="margin:10px 0 0 18px;">
        ${steps.map(s => `<li style="margin:6px 0;">${s.ok ? '‚úÖ' : '‚è≥'} ${s.label}</li>`).join('')}
      </ul>
    </div>
  `;
}

function photosHTML(d){
  if (!Array.isArray(d.photos) || !d.photos.length) return '';
  return `
    <div class="card tight" style="margin-top:10px;">
      <b>üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</b>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;">
        ${d.photos.map(p=>`
          <a href="${p.public_url}" target="_blank" rel="noopener" style="display:block;">
            <img src="${p.public_url}" alt="${p.phase}" style="width:100%;height:110px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,.08);" />
          </a>
        `).join('')}
      </div>
    </div>
  `;
}

function reviewHTML(d){
  const done = String(d.job_status||'').trim()==='‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
  if (!done) return '';
  if (d.review && d.review.already_reviewed) {
    return `
      <div class="card tight" style="margin-top:10px;">
        <b>‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</b>
        <div style="margin-top:6px;">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>${d.review.rating || '-'}</b> / 5</div>
        ${d.review.review_text ? `<div class="muted" style="margin-top:6px;">"${String(d.review.review_text).replace(/</g,'&lt;')}"</div>` : ''}
      </div>
    `;
  }
  return `
    <div class="card tight" style="margin-top:10px;border-style:dashed;">
      <b>‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡πà‡∏≤‡∏á</b>
      <div class="muted" style="margin-top:6px;">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
      <div class="grid2" style="margin-top:8px;">
        <select id="rate">
          <option value="5">5 - ‡∏î‡∏µ‡∏°‡∏≤‡∏Å</option>
          <option value="4">4 - ‡∏î‡∏µ</option>
          <option value="3">3 - ‡∏û‡∏≠‡πÉ‡∏ä‡πâ</option>
          <option value="2">2 - ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</option>
          <option value="1">1 - ‡πÅ‡∏¢‡πà</option>
        </select>
        <button type="button" onclick="submitReview('${d.booking_token || d.booking_code || ''}')">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
      <textarea id="review_text" rows="3" style="margin-top:8px;" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
      <textarea id="complaint_text" rows="2" style="margin-top:8px;" placeholder="‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
      <div id="review_status" class="muted" style="margin-top:6px;"></div>
    </div>
  `;
}

// ‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
async function submitReview(key){
  const status = document.getElementById('review_status');
  if (status) status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...';
  try{
    const rate = Number(document.getElementById('rate')?.value || 5);
    const review_text = document.getElementById('review_text')?.value || '';
    const complaint_text = document.getElementById('complaint_text')?.value || '';
    const res = await fetch(`${API}/public/review`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ q:key, rating: rate, review_text, complaint_text })
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || '‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    if (status) status.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö';
    // refresh
    setTimeout(()=>track(), 600);
  }catch(e){
    if (status) status.textContent = `‚ùå ${e.message}`;
  }
}

function openNav(lat,lng,addr){
  let url="";
  const has = lat!==null && lng!==null && lat!==undefined && lng!==undefined && !Number.isNaN(Number(lat)) && !Number.isNaN(Number(lng));
  if(has){
    url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}&travelmode=driving`;
  }else{
    const q=(addr||"").toString().trim();
    if(!q) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á");
    url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  window.open(url,"_blank");
}

async function track(){
  const qEl = document.getElementById("q");
  const q = (qEl.value || "").trim();
  if(!q) return alert("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token");

  const box = document.getElementById("result");
  box.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

  try{
    const res = await fetch(`${API}/public/track?q=${encodeURIComponent(q)}`);
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    const dt = data.appointment_datetime ? new Date(data.appointment_datetime).toLocaleString("th-TH") : "-";
    const tech = data.technician;

    const tel = tech && tech.phone ? String(tech.phone).trim() : "";
    const telBtn = tel ? `<button class="secondary" type="button" onclick="location.href='tel:${tel}'">üìû ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ä‡πà‡∏≤‡∏á</button>` : "";
    const receiptBtn = data.receipt_url ? `<a class="btn" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;" href="${data.receipt_url}" target="_blank" rel="noopener">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a>` : "";

    box.innerHTML = `
      <div class="job-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <b>üìå Booking: ${data.booking_code || "-"}</b>
          ${statusBadge(data.job_status)}
        </div>

        <p style="margin-top:10px;"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${data.customer_name || "-"}</p>
        <p><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${data.job_type || "-"}</p>
        <p><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${dt}</p>
        <p><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${data.address_text || "-"}</p>

        <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap;">
          <button class="secondary" type="button" onclick="openNav(${data.gps_latitude ?? "null"}, ${data.gps_longitude ?? "null"}, '${String(data.address_text||"").replace(/'/g,"\\'")}')">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
          ${receiptBtn}
          ${telBtn}
        </div>

        ${timelineHTML(data)}

        <hr style="margin:10px 0;">

        <div>
          <b>üë®‚Äçüîß ‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</b>
          ${tech ? `
            <div style="display:flex;gap:10px;align-items:center;margin-top:8px;">
              <img src="${tech.photo || "/logo.png"}" style="width:56px;height:56px;border-radius:999px;object-fit:cover;border:2px solid rgba(37,99,235,0.25);background:#fff;">
              <div>
                <div><b>${tech.full_name || tech.username || "-"}</b></div>
                <div class="muted">‚≠ê ${tech.rating ?? 0} ¬∑ ‡πÄ‡∏Å‡∏£‡∏î ${tech.grade || "-"}</div>
                ${tech.phone ? `<div class="muted" style="margin-top:4px;">‚òéÔ∏è ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</div>` : ``}
              </div>
            </div>
          ` : `<div class="muted" style="margin-top:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢/‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏î‡∏£‡∏±‡∏ö)</div>`}
        </div>

        ${data.technician_note ? `
          <div class="card tight" style="margin-top:10px;">
            <b>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≤‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</b>
            <div class="muted" style="margin-top:6px;white-space:pre-wrap;">${String(data.technician_note).replace(/</g,'&lt;')}</div>
          </div>
        ` : ``}

        ${photosHTML(data)}

        ${reviewHTML(data)}

        <div class="muted" style="margin-top:10px;">* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÇ‡∏ó‡∏£ 098-877-7321 ‡∏´‡∏£‡∏∑‡∏≠ LINE OA: @cwfair</div>
      </div>
    `;
  }catch(e){
    box.innerHTML = `<div class="muted">‚ùå ${e.message}</div>`;
  }
}

// auto load from query string
const q0 = qs("q") || qs("token") || "";
if(q0){
  document.getElementById("q").value = q0;
  track();
}
</script>
</body>
</html>
