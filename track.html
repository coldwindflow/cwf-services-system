<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="theme-2">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
          <span class="muted">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button"
        onclick="location.href='/customer.html'">üìÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
    </div>

    <div class="card">
      <div class="grid2">
        <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô CWF0000123 ‡∏´‡∏£‡∏∑‡∏≠ token" />
        <button type="button" onclick="track()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="muted" style="margin-top:8px;">* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>üìå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h2>
      <div id="result" class="muted" style="margin-top:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    </div>
  </div>

<script>
const API = window.location.origin;

function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

function statusBadge(st){
  const s = String(st||"").trim();
  if(s==="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£") return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
  if(s==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥") return '<span class="badge run">üõ†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>';
  if(s==="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß") return '<span class="badge ok">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
  if(s==="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") return '<span class="badge bad">‚õî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
  return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
}

function openNav(lat,lng,addr){
  let url="";
  const has = lat!==null && lng!==null && lat!==undefined && lng!==undefined && !Number.isNaN(Number(lat)) && !Number.isNaN(Number(lng));
  if(has){
    url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}&travelmode=driving`;
  }else{
    const q=(addr||"").toString().trim();
    if(!q) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á");
    url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  window.open(url,"_blank");
}

async function track(){
  const qEl = document.getElementById("q");
  const q = (qEl.value || "").trim();
  if(!q) return alert("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token");

  const box = document.getElementById("result");
  box.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

  try{
    const res = await fetch(`${API}/public/track?q=${encodeURIComponent(q)}`);
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    const dt = data.appointment_datetime ? new Date(data.appointment_datetime).toLocaleString("th-TH") : "-";
    const tech = data.technician;

    box.innerHTML = `
      <div class="job-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <b>üìå Booking: ${data.booking_code || "-"}</b>
          ${statusBadge(data.job_status)}
        </div>

        <p style="margin-top:10px;"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${data.customer_name || "-"}</p>
        <p><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${data.job_type || "-"}</p>
        <p><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${dt}</p>
        <p><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${data.address_text || "-"}</p>

        <div class="row" style="margin-top:10px;">
          <button class="secondary" type="button" onclick="openNav(${data.gps_latitude ?? "null"}, ${data.gps_longitude ?? "null"}, '${String(data.address_text||"").replace(/'/g,"\\'")}')">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
        </div>

        <hr style="margin:10px 0;">

        <div>
          <b>üë®‚Äçüîß ‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô</b>
          ${tech ? `
            <div style="display:flex;gap:10px;align-items:center;margin-top:8px;">
              <img src="${tech.photo || "/logo.png"}" style="width:56px;height:56px;border-radius:999px;object-fit:cover;border:2px solid rgba(37,99,235,0.25);background:#fff;">
              <div>
                <div><b>${tech.full_name || tech.username || "-"}</b></div>
                <div class="muted">‚≠ê ${tech.rating ?? 0} ¬∑ ‡πÄ‡∏Å‡∏£‡∏î ${tech.grade || "-"}</div>
              </div>
            </div>
          ` : `<div class="muted" style="margin-top:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢/‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏î‡∏£‡∏±‡∏ö)</div>`}
        </div>

        <div class="muted" style="margin-top:10px;">* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÇ‡∏ó‡∏£ 098-877-7321 ‡∏´‡∏£‡∏∑‡∏≠ LINE OA: @cwfair</div>
      </div>
    `;
  }catch(e){
    box.innerHTML = `<div class="muted">‚ùå ${e.message}</div>`;
  }
}

// auto load from query string
const q0 = qs("q") || qs("token") || "";
if(q0){
  document.getElementById("q").value = q0;
  track();
}
</script>
</body>
</html>
