<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* =====================================================
       üßæ E-Slip (Customer Tracking Page Only)
       - ‡πÅ‡∏Å‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ù‡∏±‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
       - ‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö logic/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/endpoint ‡πÉ‡∏î ‡πÜ
       ===================================================== */
    .eslip-wrap{ margin-top:12px; }
    .eslip{
      background:#ffffff;
      border:1px solid rgba(15,23,42,0.10);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(2,6,23,0.08);
    }
    .eslip-head{ text-align:center; }
    .eslip-head .h1{ font-weight:900; font-size:18px; }
    .eslip-head .h2{ margin-top:4px; font-weight:800; font-size:14px; color:#0f172a; }
    .eslip-meta{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .eslip-meta .box{ padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:rgba(37,99,235,0.04); }
    .eslip-table{ width:100%; border-collapse:collapse; margin-top:12px; }
    .eslip-table th,.eslip-table td{ border:1px solid rgba(15,23,42,0.10); padding:8px; font-size:13px; }
    .eslip-table th{ background: rgba(37,99,235,0.08); text-align:left; }
    .eslip-sum{ margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:#fff; }
    .eslip-sum .row{ display:flex; justify-content:space-between; gap:10px; margin:6px 0; }
    .eslip-sum .total{ font-size:18px; font-weight:900; }
    .eslip-foot{ margin-top:12px; text-align:center; color:#475569; font-size:12.5px; line-height:1.45; }
  
    .eslip-actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:10px; flex-wrap:wrap; }
    .eslip-actions button{ width:auto; min-height:40px; padding:10px 12px; }
    .eslip-logo{ width: min(220px, 55vw); height:auto; max-height:90px; object-fit:contain; display:block; margin:0 auto 8px; }

    /* üñ®Ô∏è Print: ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ E-Slip */
    @media print{
      body *{ visibility:hidden !important; }
      #docMount, #docMount *{ visibility:visible !important; }
      #docMount{ position:fixed; left:0; top:0; width:100%; margin:0; padding:0; }
      .eslip{ box-shadow:none !important; border:none !important; border-radius:0 !important; }
      .eslip-actions{ display:none !important; }
      .topbar{ display:none !important; }
      .app{ padding:0 !important; }
    }

</style>
</head>
<body class="theme-2">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
          <span class="muted">‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button"
        onclick="location.href='/customer.html'">üìÖ ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
    </div>

    <div class="card">
      <div class="grid2">
        <input id="q" placeholder="‡πÄ‡∏ä‡πà‡∏ô CWF0000123 ‡∏´‡∏£‡∏∑‡∏≠ token" />
        <button type="button" onclick="track()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <div class="muted" style="margin-top:8px;">* ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏Ç Booking ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏á‡πà‡∏≤‡∏¢</div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>üìå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</h2>
      <div id="result" class="muted" style="margin-top:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    </div>
  </div>

<script>
const API = window.location.origin;

// ==============================
// üîí Helper: escape HTML
// ==============================
function esc(s){
  return String(s ?? "").replace(/[&<>"']/g, (m) => ({
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': "&quot;",
    "'": "&#39;"
  }[m]));
}

// ==============================
// üßæ E-Slip (Customer view)
// - ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ job_status = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß'
// - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å /docs/receipt/:job_id)
// - ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö field
// ==============================
function isDoneStatus(jobStatus){
  // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö: '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' ‡∏´‡∏£‡∏∑‡∏≠ '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'
  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ù‡∏±‡πà‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/logic ‡∏ù‡∏±‡πà‡∏á backend)
  const s = String(jobStatus || "").trim();
  return (s === "‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß" || s === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô");
}

// ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (‡∏Å‡∏±‡∏ô backend ‡∏™‡πà‡∏á localhost / ‡∏Ñ‡∏ô‡∏•‡∏∞‡πÇ‡∏î‡πÄ‡∏°‡∏ô)
// - ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error 'Failed to fetch' ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/PWA
function buildReceiptUrl(jobData){
  const id = jobData?.job_id;
  const fallback = id ? `${API}/docs/receipt/${encodeURIComponent(id)}` : "";
  const raw = String(jobData?.receipt_url || "").trim();
  if(!raw) return fallback;

  try{
    // new URL ‡∏à‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á absolute ‡πÅ‡∏•‡∏∞ relative
    const u = new URL(raw, API);

    // ‡∏ñ‡πâ‡∏≤ backend ‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå localhost/127.0.0.1 ‡∏´‡∏£‡∏∑‡∏≠ origin ‡∏Ñ‡∏ô‡∏•‡∏∞‡πÇ‡∏î‡πÄ‡∏°‡∏ô
    // ‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î origin ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏±‡∏ô CORS/‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
    const isLocalHost = (u.hostname === "localhost" || u.hostname === "127.0.0.1" || u.hostname === "0.0.0.0");
    const isDifferentOrigin = (u.origin !== API);

    if (isLocalHost || isDifferentOrigin){
      return `${API}${u.pathname}${u.search}`;
    }

    return u.href;
  }catch(e){
    // fallback ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
    return fallback || raw;
  }
}

// ‚úÖ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏° (HTML) ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô E-Slip ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
async function renderCustomerESlip(jobData){
  const mount = document.getElementById("docMount");
  if(!mount) return;

  // ‚ùå ‡∏á‡∏≤‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à: ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏î ‡πÜ
  if(!isDoneStatus(jobData?.job_status)){
    mount.innerHTML = "";
    return;
  }

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å (‡πÅ‡∏ï‡πà‡∏Å‡∏±‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ú‡∏¥‡∏î ‡πÄ‡∏ä‡πà‡∏ô localhost)
  const receiptUrl = buildReceiptUrl(jobData);
  if(!receiptUrl){
    mount.innerHTML = "";
    return;
  }

  mount.innerHTML = `<div class="muted" style="margin-top:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip...</div>`;

  try{
    const r = await fetch(receiptUrl, { cache: "no-store", credentials: "include" });
    const html = await r.text();
    if(!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    // ‚úÖ Parse HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ backend)
    const doc = new DOMParser().parseFromString(html, "text/html");
    const table = doc.querySelector("table");

    // rows => [[name, qty, unit, total], ...]
    const rows = Array.from(table?.querySelectorAll("tbody tr") || []).map(tr => {
      const tds = Array.from(tr.querySelectorAll("td")).map(td => (td.textContent || "").trim());
      return {
        name: tds[0] || "-",
        qty: tds[1] || "-",
        unit: tds[2] || "-",
        line: tds[3] || "-",
      };
    });

    // ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î: ‡∏´‡∏≤ box ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥'
    const boxes = Array.from(doc.querySelectorAll(".box"));
    const sumBox = boxes.find(b => (b.textContent || "").includes("‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")) || null;
    const sumText = (sumBox?.textContent || "").replace(/\s+/g," ").trim();

    // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
    const subtotal = (sumText.match(/‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const discount = (sumText.match(/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const total = (sumText.match(/‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:\s*([0-9,\.]+)/) || [])[1] || "-";

    const booking = jobData.booking_code || "-";
    const printedAt = new Date().toLocaleString("th-TH");

    // ‚úÖ ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö E-Slip ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á 100%)
    mount.innerHTML = `
      <div class="eslip-wrap">
        <div class="eslip">
          <div class="eslip-head">
            <img class="eslip-logo" src="/logo.png" alt="Coldwindflow Air Services">
            <div class="h1">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (E-Receipt)</div>
            <div class="h2">Coldwindflow Air Services</div>
          </div>

          <div class="eslip-meta">
            <div class="box"><b>Booking:</b> ${esc(booking)}</div>
            <div class="box"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</b> ${esc(printedAt)}</div>
          </div>

          <div class="eslip-actions">
            <button type="button" onclick="window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
          </div>

          <div style="margin-top:10px;">
            <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${esc(jobData.customer_name || "-")}</div>
            <div><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${esc(jobData.customer_phone || "-")}</div>
            <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${esc(jobData.job_type || "-")}</div>
            <div><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${esc(jobData.appointment_datetime ? new Date(jobData.appointment_datetime).toLocaleString("th-TH") : "-")}</div>
            <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${esc(jobData.address_text || "-")}</div>
          </div>

          <table class="eslip-table" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤">
            <thead>
              <tr>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                <th style="text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                <th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                <th style="text-align:right;">‡∏£‡∏ß‡∏°</th>
              </tr>
            </thead>
            <tbody>
              ${(rows.length ? rows : [{name:"-",qty:"-",unit:"-",line:"-"}]).map(it => `
                <tr>
                  <td>${esc(it.name)}</td>
                  <td style="text-align:right;">${esc(it.qty)}</td>
                  <td style="text-align:right;">${esc(it.unit)}</td>
                  <td style="text-align:right;">${esc(it.line)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>

          <div class="eslip-sum">
            <div class="row"><span>‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</span><b>${esc(subtotal)}</b></div>
            <div class="row"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><b>${esc(discount)}</b></div>
            <div class="row total"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>${esc(total)}</span></div>
          </div>

          <div class="eslip-foot">
            ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
            ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ<br>
            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
          </div>
        </div>
      </div>
    `;
  }catch(e){
    mount.innerHTML = `<div class="muted" style="margin-top:10px;">‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${esc(e.message)}</div>`;
  }
}

function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

function statusBadge(st){
  const s = String(st||"").trim();
  if(s==="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£") return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
  if(s==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥") return '<span class="badge run">üõ†Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</span>';
  if(s==="‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß") return '<span class="badge ok">‚úÖ ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</span>';
  if(s==="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å") return '<span class="badge bad">‚õî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>';
  return '<span class="badge wait">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>';
}

// ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å timestamps ‡∏à‡∏£‡∏¥‡∏á)
function derivedStatus(d){
  const s = String(d.job_status || '').trim();
  if (s === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') return '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
  if (s === '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
  if (d.started_at) return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
  if (d.checkin_at) return '‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
  if (d.travel_started_at) return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á';
  return '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô';
}

function timelineHTML(d){
  const steps = [
    { k: 'accepted', label: '‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô / ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', ok: !!d.technician },
    { k: 'travel', label: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á', ok: !!d.travel_started_at },
    { k: 'checkin', label: '‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô)', ok: !!d.checkin_at },
    { k: 'start', label: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', ok: !!d.started_at },
    { k: 'done', label: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô', ok: String(d.job_status||'').trim()==='‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' },
  ];
  return `
    <div class="card tight" style="margin-top:10px;">
      <b>üìç ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</b>
      <div class="muted" style="margin-top:6px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${derivedStatus(d)}</b></div>
      <ul style="margin:10px 0 0 18px;">
        ${steps.map(s => `<li style="margin:6px 0;">${s.ok ? '‚úÖ' : '‚è≥'} ${s.label}</li>`).join('')}
      </ul>
    </div>
  `;
}

function photosHTML(d){
  if (!Array.isArray(d.photos) || !d.photos.length) return '';
  return `
    <div class="card tight" style="margin-top:10px;">
      <b>üì∑ ‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)</b>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;">
        ${d.photos.map(p=>`
          <a href="${p.public_url}" target="_blank" rel="noopener" style="display:block;">
            <img src="${p.public_url}" alt="${p.phase}" style="width:100%;height:110px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,.08);" />
          </a>
        `).join('')}
      </div>
    </div>
  `;
}

function reviewHTML(d){
  const done = String(d.job_status||'').trim()==='‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß';
  if (!done) return '';
  if (d.review && d.review.already_reviewed) {
    return `
      <div class="card tight" style="margin-top:10px;">
        <b>‚≠ê ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</b>
        <div style="margin-top:6px;">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <b>${d.review.rating || '-'}</b> / 5</div>
        ${d.review.review_text ? `<div class="muted" style="margin-top:6px;">"${String(d.review.review_text).replace(/</g,'&lt;')}"</div>` : ''}
      </div>
    `;
  }
  return `
    <div class="card tight" style="margin-top:10px;border-style:dashed;">
      <b>‚≠ê ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ä‡πà‡∏≤‡∏á</b>
      <div class="muted" style="margin-top:6px;">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
      <div class="grid2" style="margin-top:8px;">
        <select id="rate">
          <option value="5">5 - ‡∏î‡∏µ‡∏°‡∏≤‡∏Å</option>
          <option value="4">4 - ‡∏î‡∏µ</option>
          <option value="3">3 - ‡∏û‡∏≠‡πÉ‡∏ä‡πâ</option>
          <option value="2">2 - ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</option>
          <option value="1">1 - ‡πÅ‡∏¢‡πà</option>
        </select>
        <button type="button" onclick="submitReview('${d.booking_token || d.booking_code || ''}')">‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</button>
      </div>
      <textarea id="review_text" rows="3" style="margin-top:8px;" placeholder="‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
      <textarea id="complaint_text" rows="2" style="margin-top:8px;" placeholder="‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
      <div id="review_status" class="muted" style="margin-top:6px;"></div>
    </div>
  `;
}

// ‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß (‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
async function submitReview(key){
  const status = document.getElementById('review_status');
  if (status) status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß...';
  try{
    const rate = Number(document.getElementById('rate')?.value || 5);
    const review_text = document.getElementById('review_text')?.value || '';
    const complaint_text = document.getElementById('complaint_text')?.value || '';
    const res = await fetch(`${API}/public/review`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ q:key, rating: rate, review_text, complaint_text })
    });
    const data = await res.json().catch(()=>({}));
    if (!res.ok) throw new Error(data.error || '‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    if (status) status.textContent = '‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö';
    // refresh
    setTimeout(()=>track(), 600);
  }catch(e){
    if (status) status.textContent = `‚ùå ${e.message}`;
  }
}

function openNav(lat,lng,addr){
  let url="";
  const has = lat!==null && lng!==null && lat!==undefined && lng!==undefined && !Number.isNaN(Number(lat)) && !Number.isNaN(Number(lng));
  if(has){
    url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(lat + "," + lng)}&travelmode=driving`;
  }else{
    const q=(addr||"").toString().trim();
    if(!q) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡∏ó‡∏≤‡∏á");
    url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
  }
  window.open(url,"_blank");
}

async function track(){
  const qEl = document.getElementById("q");
  const q = (qEl.value || "").trim();
  if(!q) return alert("‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç Booking ‡∏´‡∏£‡∏∑‡∏≠ token");

  const box = document.getElementById("result");
  box.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";

  try{
    const res = await fetch(`${API}/public/track?q=${encodeURIComponent(q)}`);
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    const dt = data.appointment_datetime ? new Date(data.appointment_datetime).toLocaleString("th-TH") : "-";
    const techTeam = Array.isArray(data.technician_team)
      ? data.technician_team
      : (data.technician ? [data.technician] : []);

    // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏ó‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ)
    const firstTel = techTeam.find(t => t && t.phone) ? String(techTeam.find(t => t && t.phone).phone).trim() : "";
    const telBtn = firstTel ? `<button class="secondary" type="button" onclick="location.href='tel:${firstTel}'">üìû ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏ä‡πà‡∏≤‡∏á</button>` : "";
    // ‚ùå ‡∏ï‡∏≤‡∏° requirement: ‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ E-Slip ‡πÉ‡∏´‡∏°‡πà
    const receiptBtn = "";

    box.innerHTML = `
      <div class="job-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
          <b>üìå Booking: ${data.booking_code || "-"}</b>
          ${statusBadge(data.job_status)}
        </div>

        <p style="margin-top:10px;"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${data.customer_name || "-"}</p>
        <p><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${data.job_type || "-"}</p>
        <p><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${dt}</p>
        <p><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${data.address_text || "-"}</p>

        <div class="row" style="margin-top:10px;gap:10px;flex-wrap:wrap;">
          <button class="secondary" type="button" onclick="openNav(${data.gps_latitude ?? "null"}, ${data.gps_longitude ?? "null"}, '${String(data.address_text||"").replace(/'/g,"\\'")}')">üß≠ ‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</button>
          ${receiptBtn}
          ${telBtn}
        </div>

        ${timelineHTML(data)}

        <hr style="margin:10px 0;">

        <div>
          <b>üë®‚Äçüîß ‡∏ä‡πà‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏á‡∏≤‡∏ô</b>
          ${techTeam && techTeam.length ? `
            <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
              ${techTeam.map(t => {
                const name = t.full_name || t.username || "-";
                const photo = t.photo || "/logo.png";
                const phone = t.phone ? String(t.phone).trim() : "";
                const telLink = phone ? `tel:${phone}` : "";
                return `
                  <div style="display:flex;gap:10px;align-items:center;">
                    <img src="${photo}" style="width:56px;height:56px;border-radius:999px;object-fit:cover;border:2px solid rgba(37,99,235,0.25);background:#fff;">
                    <div style="flex:1;min-width:0;">
                      <div><b>${esc(name)}</b></div>
                      <div class="muted">‚≠ê ${t.rating ?? 0} ¬∑ ‡πÄ‡∏Å‡∏£‡∏î ${esc(t.grade || "-")}</div>
                      <div class="muted" style="margin-top:4px;">
                        ${phone ? `‚òéÔ∏è <a href="${telLink}">${esc(phone)}</a>` : `‚òéÔ∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£`}
                      </div>
                    </div>
                    ${phone ? `<button class="secondary" type="button" style="width:auto;" onclick="location.href='${telLink}'">‡πÇ‡∏ó‡∏£</button>` : ``}
                  </div>
                `;
              }).join('')}
            </div>
          ` : `<div class="muted" style="margin-top:6px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô (‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢/‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏î‡∏£‡∏±‡∏ö)</div>`}
        </div>

        ${data.technician_note ? `
          <div class="card tight" style="margin-top:10px;">
            <b>üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡∏ä‡πà‡∏≤‡∏á (‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô)</b>
            <div class="muted" style="margin-top:6px;white-space:pre-wrap;">${String(data.technician_note).replace(/</g,'&lt;')}</div>
          </div>
        ` : ``}

        ${photosHTML(data)}

        ${reviewHTML(data)}

        <!-- ‚úÖ E-Slip ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô = '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' (job_status = '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß') -->
        <div id="docMount"></div>

        <div class="muted" style="margin-top:10px;">* ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÇ‡∏ó‡∏£ 098-877-7321 ‡∏´‡∏£‡∏∑‡∏≠ LINE OA: @cwfair</div>
      </div>
    `;

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡πÅ‡∏™‡∏î‡∏á E-Slip ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à)
    try{ await renderCustomerESlip(data); }catch(e){}
  }catch(e){
    box.innerHTML = `<div class="muted">‚ùå ${e.message}</div>`;
  }
}

// auto load from query string
const q0 = qs("q") || qs("token") || "";
if(q0){
  document.getElementById("q").value = q0;
  track();
}
</script>
</body>
</html>
