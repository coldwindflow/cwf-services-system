<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô</title>
  <!-- cache-bust: ensure latest css in PWA/Android webview -->
  <link rel="stylesheet" href="style.css?v=17">
  <link rel="manifest" href="/mainfest.json">
  <meta name="theme-color" content="#0b4bb3">
</head>
<body class="theme-2 customer-page">
  <!-- ===== Customer Debug FAB + Panel (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô) ===== -->
  <button id="cust_debug_fab" class="cust-debug-fab" type="button" aria-label="Debug" onclick="window.__cwfDbg && window.__cwfDbg.toggle()">üêû</button>
  <div id="cust_debug_panel" class="cust-debug-panel" style="display:none;" aria-hidden="true">
    <div class="hd">
      <b>Debug Panel</b>
      <div class="actions">
        <button type="button" class="mini" onclick="window.__cwfDbg && window.__cwfDbg.clear()">‡∏•‡πâ‡∏≤‡∏á</button>
        <button type="button" class="mini" onclick="window.__cwfDbg && window.__cwfDbg.copy()">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        <button type="button" class="mini" onclick="window.__cwfDbg && window.__cwfDbg.close()">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <div class="bd">
      <div class="row">
        <button type="button" class="mini primary" onclick="window.__cwfDbg && window.__cwfDbg.refreshLine()">Refresh LINE Config</button>
        <button type="button" class="mini" onclick="window.__cwfDbg && window.__cwfDbg.testSlots()">Test Slots (debug=1)</button>
      </div>
      <div class="muted2 mini" style="margin-top:8px;">* ‡πÄ‡∏õ‡∏¥‡∏î Debug Panel ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Test Slots ‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå URL/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà backend ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö</div>
      <pre id="cust_debug_log" class="cust-debug-log"></pre>
    </div>
  </div>

  <script>
    // ===== Minimal early debug logger (must be before other scripts) =====
    (function(){
      const panel = () => document.getElementById('cust_debug_panel');
      const logEl = () => document.getElementById('cust_debug_log');
      const ts = () => new Date().toISOString();
      const safeStr = (v) => {
        try { return (typeof v === 'string') ? v : JSON.stringify(v, null, 2); }
        catch(_) { return String(v); }
      };
      const append = (msg, obj) => {
        const el = logEl();
        if(!el) return;
        const line = `[${ts()}] ${msg}` + (obj !== undefined ? `\n${safeStr(obj)}` : '') + `\n`;
        el.textContent += line;
        el.scrollTop = el.scrollHeight;
      };

      window.__cwfDbg = {
        open(){ const p=panel(); if(p){ p.style.display='block'; p.setAttribute('aria-hidden','false'); } },
        close(){ const p=panel(); if(p){ p.style.display='none'; p.setAttribute('aria-hidden','true'); } },
        toggle(){ const p=panel(); if(!p) return; const on = p.style.display !== 'none'; on ? this.close() : this.open(); },
        clear(){ const el=logEl(); if(el) el.textContent=''; },
        copy(){
          const el=logEl();
          const txt = el ? el.textContent : '';
          try{ navigator.clipboard.writeText(txt||''); append('‚úÖ copied'); }catch(e){ append('‚ùå copy failed', e?.message||e); }
        },
        log: append,
        async refreshLine(){
          append('‚Üí GET /public/line_config');
          try{
            const r = await fetch(`${window.location.origin}/public/line_config`, { credentials:'include' });
            const t = await r.text();
            let j=null; try{ j=JSON.parse(t);}catch(_){ }
            append(`‚Üê status ${r.status}`, j || t);
          }catch(e){ append('‚ùå line_config error', e?.message||e); }
        },
        async testSlots(){
          try{
            const d = document.getElementById('date')?.value || '';
            const dur = (window.durationMin || 60);
            const urgent = document.getElementById('urgent_toggle')?.checked;
            const tech_type = urgent ? 'partner' : 'company';
            if(!d){ append('‚ùå no date selected'); return; }
            let url = `${window.location.origin}/public/availability_v2?date=${encodeURIComponent(d)}&tech_type=${encodeURIComponent(tech_type)}&duration_min=${encodeURIComponent(dur)}&debug=1&include_full=1`;
            try{
              const payload = (typeof window.getPayloadV2 === 'function') ? window.getPayloadV2() : null;
              if(payload){
                if(payload.services && Array.isArray(payload.services) && payload.services.length){
                  url += `&services=${encodeURIComponent(JSON.stringify(payload.services))}`;
                } else {
                  url += `&job_type=${encodeURIComponent(payload.job_type||'')}&ac_type=${encodeURIComponent(payload.ac_type||'')}&wash_variant=${encodeURIComponent(payload.wash_variant||'')}&repair_variant=${encodeURIComponent(payload.repair_variant||'')}`;
                }
              }
            }catch(_){ }
            append('‚Üí ' + url);
            const r = await fetch(url, { credentials:'include' });
            const t = await r.text();
            let j=null; try{ j=JSON.parse(t);}catch(_){ }
            append(`‚Üê status ${r.status}`, j || t);
          }catch(e){ append('‚ùå testSlots error', e?.message||e); }
        }
      };

      window.addEventListener('error', (ev) => {
        append('üí• window.error', { message: ev?.message, filename: ev?.filename, lineno: ev?.lineno, colno: ev?.colno });
      });
      window.addEventListener('unhandledrejection', (ev) => {
        append('üí• unhandledrejection', { reason: safeStr(ev?.reason) });
      });
    })();
  </script>
  <div class="app">
    <!-- Top nav (admin/tech-like) with customer theme -->
    <div id="custTopNav">
      <div class="in">
        <div class="brand">
          <!-- Customer profile (replaces app logo) -->
          <button id="brand_avatar_btn" class="brand-avatar" type="button" aria-label="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" title="‡∏î‡∏π/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà">
            <img id="brand_avatar_img" alt="" style="display:none;" />
            <span id="brand_avatar_ph" class="ph" aria-hidden="true">üë§</span>
          </button>
          <div class="title">
            <b id="cust_header_primary">üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
            <span id="cust_header_secondary">Coldwindflow air services</span>
          </div>
        </div>
        <div class="custTopRight">
          <!-- menu + logout (no overlap) -->
          <!-- inline onclick fallback: ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ JS init ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô crash ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ -->
          <button id="menu_btn" class="cust-icbtn" type="button" aria-label="‡πÄ‡∏°‡∏ô‡∏π" aria-expanded="false" onclick="window.__cwfToggleMenu && window.__cwfToggleMenu()">‚ò∞</button>
          <button id="logout_btn" class="cust-logoutbtn" type="button" aria-label="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö" style="display:none;">‚éã</button>
        </div>
      </div>
    </div>
    <div id="custTopSpacer" aria-hidden="true"></div>

    <!-- Drawer menu (admin/tech-like) -->
    <div id="menu_overlay" class="cust-drawer-backdrop" style="display:none;" onclick="window.__cwfCloseMenu && window.__cwfCloseMenu()"></div>
    <div id="menu_drawer" class="cust-drawer" style="display:none;" aria-hidden="true">
      <div class="panel">
        <div class="custMenuHead">
          <b>‡πÄ‡∏°‡∏ô‡∏π</b>
          <button id="menu_close" class="cust-icbtn close" type="button" aria-label="‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π" onclick="window.__cwfCloseMenu && window.__cwfCloseMenu()">‚úï</button>
        </div>

        <div class="custMenuList">
          <a id="line_login_btn" class="custMenuBtn" href="/auth/line">
            <span class="left">‚úÖ Login ‡∏î‡πâ‡∏ß‡∏¢ LINE</span>
            <span class="sub">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
          </a>
          <a id="register_btn" class="custMenuBtn" style="display:none;" href="/register">
            <span class="left">üìç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</span>
            <span class="sub">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </a>
          <div id="me_badge" class="me-badge" style="display:none;margin-top:6px;">
            <img id="me_pic" alt="" class="me-pic">
            <b id="me_name" class="me-name"></b>
          </div>

          <button class="custMenuBtn" type="button" onclick="location.href='/install-quote'">
            <span class="left">üßÆ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</span>
            <span class="sub">‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏≤‡∏Ñ‡∏≤</span>
          </button>
          <button class="custMenuBtn" type="button" onclick="location.href='/track.html'">
            <span class="left">üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</span>
            <span class="sub">‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
          </button>

          <button id="drawer_logout_btn" class="custMenuBtn danger" type="button" style="display:none;">
            <span class="left">‚éã ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            <span class="sub">Logout</span>
          </button>
        </div>

        <div class="custMenuSmall">Coldwindflow air services</div>
      </div>
    </div>

    <!-- Address modal (view/edit) -->
    <div id="addr_modal" class="cust-modal" style="display:none;" aria-hidden="true">
      <div class="backdrop" id="addr_modal_backdrop"></div>
      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="addr_modal_title">
        <div class="hd">
          <b id="addr_modal_title">üìç ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</b>
          <button id="addr_modal_close" class="cust-icbtn close" type="button" aria-label="‡∏õ‡∏¥‡∏î">‚úï</button>
        </div>
        <div class="bd">
          <div id="addr_view">
            <div class="muted" style="margin-bottom:6px;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
            <div id="addr_text" class="addr-text">-</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
              <a id="addr_maps_open" class="custMiniBtn" href="#" target="_blank" rel="noopener" style="display:none;">üó∫Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
              <button id="addr_edit_btn" class="custMiniBtn" type="button">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</button>
            </div>
            <div class="muted" style="margin-top:10px;font-size:12px;">* ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ</div>
          </div>

          <div id="addr_edit" style="display:none;">
            <label class="muted" style="display:block;margin-bottom:6px;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
            <textarea id="addr_input" rows="4" style="width:100%;"></textarea>
            <label class="muted" style="display:block;margin:10px 0 6px;">‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
            <input id="maps_input" type="text" placeholder="https://maps.app.goo.gl/..." style="width:100%;">
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
              <button id="addr_save_btn" class="custMiniBtn primary" type="button">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              <button id="addr_cancel_btn" class="custMiniBtn" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            <div id="addr_save_result" class="muted" style="margin-top:10px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- OPTIONAL-6: Trust signals (minimal + no regression) -->
    <div class="trust-bar">
      <div class="trust-pills">
        <span class="trust-pill">‚úÖ ‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
        <span class="trust-pill">üõ°Ô∏è ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏á‡∏≤‡∏ô</span>
        <span class="trust-pill">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏î‡πâ</span>
        <span class="trust-pill">üí¨ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ LINE OA</span>
      </div>
      <div class="trust-actions">
        <a class="trust-btn phone" href="tel:0988777321">üìû ‡πÇ‡∏ó‡∏£‡πÄ‡∏•‡∏¢</a>
        <a class="trust-btn line" href="https://line.me/R/ti/p/@cwfair" target="_blank" rel="noopener">üí¨ ‡πÅ‡∏ä‡∏ó‡πÑ‡∏•‡∏ô‡πå</a>
      </div>
    </div>

    
    <div class="card service-card">
      <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h2>

      <!-- ‡∏ó‡∏≥ layout ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô (‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏ó‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤) -->
      <div class="muted2 mini">‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‚Äù ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏ô‡∏±‡∏á 1 + ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á 1 + ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á 1 ‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô</label>
          <select id="job_type">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
            <option value="‡∏•‡πâ‡∏≤‡∏á">‡∏•‡πâ‡∏≤‡∏á</option>
            <option value="‡∏ã‡πà‡∏≠‡∏°">‡∏ã‡πà‡∏≠‡∏°</option>
            <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</option>
          </select>
        </div>
        <div>
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå</label>
          <select id="ac_type">
            <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå --</option>
            <option value="‡∏ú‡∏ô‡∏±‡∏á">‡∏ú‡∏ô‡∏±‡∏á (Wall Type)</option>
            <option value="‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á">‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</option>
            <option value="‡πÅ‡∏Ç‡∏ß‡∏ô">‡πÅ‡∏Ç‡∏ß‡∏ô</option>
            <option value="‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤">‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤</option>
          </select>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label>BTU</label>
          <select id="btu">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BTU</option>
            <option value="9000">9,000</option>
            <option value="12000">12,000</option>
            <option value="15000">15,000</option>
            <option value="18000">18,000</option>
            <option value="24000">24,000</option>
            <option value="30000">30,000</option>
            <option value="36000">36,000</option>
            <option value="48000">48,000</option>
            <option value="60000">60,000</option>
          </select>
        </div>
        <div>
          <label>‡πÇ‡∏´‡∏°‡∏î‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</label>
          <label class="cwf-switch" style="margin-top:8px;">
            <input id="urgent_toggle" type="checkbox">
            <span class="cwf-slider"></span>
            <span class="muted2 mini" style="margin-left:10px;">‡∏¢‡∏¥‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á‡∏£‡∏±‡∏ö (‡∏≠‡∏≤‡∏à‡∏£‡∏±‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ö‡∏Å‡πá‡πÑ‡∏î‡πâ)</span>
          </label>
        </div>
      </div>

      <!-- PATCH: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ job=‡∏•‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡∏∞ ac=‡∏ú‡∏ô‡∏±‡∏á) -->
      <div id="variant_box_customer" style="margin-top:10px; display:none;">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏≠‡∏£‡πå‡∏ú‡∏ô‡∏±‡∏á)</label>
        <select id="wash_variant"></select>
      </div>

      <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ job=‡∏ã‡πà‡∏≠‡∏°) -->
      <div id="repair_box_customer" style="margin-top:10px; display:none;">
        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</label>
        <select id="repair_variant">
          <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (500)</option>
          <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏±‡πà‡∏ß">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏±‡πà‡∏ß (1000)</option>
          <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</option>
        </select>
      </div>

      <div class="grid2" style="margin-top:10px; align-items:start;">
        <div>
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
          <div class="mc-row">
            <div class="stepper" aria-label="machine count">
              <button id="mc_minus" class="btn-round" type="button" title="‡∏•‡∏î">‚àí</button>
              <input id="machine_count" class="stepper-input" type="number" min="1" max="20" step="1" value="1" inputmode="numeric">
              <button id="mc_plus" class="btn-round" type="button" title="‡πÄ‡∏û‡∏¥‡πà‡∏°">+</button>
            </div>
            <button id="btnAddServiceLineCustomer" class="secondary" type="button" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
          </div>
          <div class="muted2 mini" style="margin-top:6px;">* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 2</div>
        </div>

        <div class="card card-lite" style="margin-top:0;">
          <b>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</b>
          <div class="muted2 mini">‡∏£‡∏≤‡∏Ñ‡∏≤/‡πÄ‡∏ß‡∏•‡∏≤ ‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤</div>
          <div style="margin-top:10px">
            <div><span class="muted2">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</span> <b><span id="grand_total">0</span></b> ‡∏ö‡∏≤‡∏ó</div>
            <div><span class="muted2">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span> <b><span id="duration_min">-</span></b> ‡∏ô‡∏≤‡∏ó‡∏µ</div>
          </div>
        </div>
      </div>

      <!-- keep these ids for existing logic (hidden but used) -->
      <div style="display:none;">
        <span id="standard_price">-</span>
      </div>

      <div class="promo-card" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
          <b>üéÅ ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</b>
          <select id="promotion_select_customer" style="width:auto;min-width:220px;"></select>
        </div>

        <div id="multi_service_box_customer" class="card card-lite" style="margin-top:12px;display:none;">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;">
            <div>
              <b>‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</b>
              <div class="muted2 mini">‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‚Äù ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</div>
            </div>
            <button id="btnClearServiceLinesCustomer" type="button" class="secondary" style="width:auto;">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
          <div id="service_lines_customer" style="margin-top:10px;"></div>
        </div>

        <div class="muted2 mini" style="margin-top:6px;">* ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á/BTU/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå/‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á)</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>2) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</h2>

      <div class="grid2">
        <input id="date" type="date">
        <button id="loadSlotsBtn" type="button" onclick="loadSlots()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</button>
      </div>

      <div id="slot_controls" class="slot-controls" style="margin-top:12px;display:none;">
        <div class="chip-group" role="tablist" aria-label="slot filter">
          <button id="filter_avail" type="button" class="chip active" aria-selected="true">‚úÖ ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</button>
          <button id="filter_all" type="button" class="chip" aria-selected="false">üìÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
        <div class="muted" style="font-size:12px;margin-top:6px;">* ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°‡∏î‡πâ‡∏ß‡∏¢</div>
      </div>

      <div id="slots" class="muted" style="margin-top:12px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‚Äù</div>

      <div class="picked-row">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <b id="picked">-</b></div>

      <div class="divider"></div>

      <h2 style="margin-top:0;">3) ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h2>

      <div class="grid2">
        <input id="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        <input id="customer_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
      </div>

      <input id="address_text" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)">

      <div class="maps-field">
        <input id="maps_url" type="url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á" autocomplete="off">
        <div class="maps-helper-row">
          <button id="maps_help_btn" class="linkish" type="button">üó∫Ô∏è ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
          <div id="maps_hint" class="muted" style="font-size:12px;">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö maps.app.goo.gl ‡πÅ‡∏•‡∏∞ google.com/maps</div>
        </div>
        <div id="maps_pop" class="maps-pop" style="display:none;">
          <b>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</b>
          <div class="muted" style="margin-top:4px;">
            ‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‚Üí ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‚Üí ‡∏Å‡∏î ‚Äú‡πÅ‡∏ä‡∏£‡πå‚Äù ‚Üí ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Üí ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ
          </div>
        </div>
        <div id="maps_preview" class="maps-preview" style="display:none;"></div>
      </div>

      <textarea id="customer_note" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>

      <!-- Summary card before confirm -->
      <div id="confirm_summary" class="summary-card" style="margin-top:12px;">
        <div class="summary-title">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="k">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</div>
            <div class="v" id="sum_datetime">-</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</div>
            <div class="v" id="sum_service">-</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</div>
            <div class="v" id="sum_price">‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£</div>
          </div>
          <div class="summary-item">
            <div class="k">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="v" id="sum_location">-</div>
          </div>
        </div>
      </div>

      <button id="confirm_btn" type="button" class="primary-cta" onclick="book()" style="margin-top:12px;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á</button>

      <div id="result" class="muted" style="margin-top:10px;"></div>
    </div>

  </div>


<script>
const API = window.location.origin;

// ===== Menu fallback (‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏≠‡∏∑‡πà‡∏ô) =====
// ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏Ñ‡∏™ JS error ‡∏Å‡πà‡∏≠‡∏ô bind listener ‚Üí ‡πÄ‡∏°‡∏ô‡∏π/‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
(function(){
  function openCustomerMenu(){
    const ov = document.getElementById('menu_overlay');
    const dr = document.getElementById('menu_drawer');
    const btn = document.getElementById('menu_btn');
    if(ov) ov.style.display = 'block';
    if(dr){ dr.style.display = 'block'; dr.setAttribute('aria-hidden','false'); }
    if(btn) btn.setAttribute('aria-expanded','true');
    try{ document.body.style.overflow = 'hidden'; }catch(_){ }
  }
  function closeCustomerMenu(){
    const ov = document.getElementById('menu_overlay');
    const dr = document.getElementById('menu_drawer');
    const btn = document.getElementById('menu_btn');
    if(ov) ov.style.display = 'none';
    if(dr){ dr.style.display = 'none'; dr.setAttribute('aria-hidden','true'); }
    if(btn) btn.setAttribute('aria-expanded','false');
    try{ document.body.style.overflow = ''; }catch(_){ }
  }
  window.__cwfToggleMenu = function(){
    const dr = document.getElementById('menu_drawer');
    const isOpen = !!(dr && dr.style.display === 'block');
    isOpen ? closeCustomerMenu() : openCustomerMenu();
  };
  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ overlay/close ‡∏ñ‡∏π‡∏Å‡∏Å‡∏î ‡πÅ‡∏ï‡πà listener ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å bind
  window.__cwfCloseMenu = closeCustomerMenu;
})();

async function loadMe(){
  try{
    const r = await fetch(`${API}/public/me`, { credentials: 'include' });
    const j = await r.json().catch(()=>({logged_in:false}));
    const loginBtn = document.getElementById('line_login_btn');
    const regBtn = document.getElementById('register_btn');
    const badge = document.getElementById('me_badge');
    const pic = document.getElementById('me_pic');
    const name = document.getElementById('me_name');

    const menuBtn = document.getElementById('menu_btn');
    const logoutBtn = document.getElementById('logout_btn');
    const drawerLogoutBtn = document.getElementById('drawer_logout_btn');

    const brandAvatarBtn = document.getElementById('brand_avatar_btn');
    const brandAvatarImg = document.getElementById('brand_avatar_img');
    const brandAvatarPh = document.getElementById('brand_avatar_ph');
    const headerPrimary = document.getElementById('cust_header_primary');
    const headerSecondary = document.getElementById('cust_header_secondary');

    // profile fields
    const profile = (j && j.profile) ? j.profile : null;
    const addr = profile && profile.address ? String(profile.address || '').trim() : '';
    const mapsUrl = profile && profile.maps_url ? String(profile.maps_url || '').trim() : '';
    const phoneFromProfile = profile && profile.phone ? String(profile.phone || '').trim() : '';

    if(j && j.logged_in){
      if(loginBtn) loginBtn.style.display = 'none';
      // show register when missing address
      if(regBtn) regBtn.style.display = addr ? 'none' : 'inline-flex';
      if(badge) badge.style.display = 'inline-flex';
      if(name) name.textContent = (j.user && j.user.name) ? j.user.name : 'Logged in';
      if(pic) {
        const u = (j.user && j.user.picture) ? j.user.picture : '';
        if(u){ pic.src = u; pic.style.display='block'; }
        else { pic.style.display='none'; }
      }

      // top-right: keep menu, show logout
      if(menuBtn) menuBtn.style.display = 'inline-flex';
      if(logoutBtn) logoutBtn.style.display = 'inline-flex';
      if(drawerLogoutBtn) drawerLogoutBtn.style.display = 'inline-flex';

      // brand avatar replaces app logo
      const u2 = (j.user && j.user.picture) ? String(j.user.picture || '') : '';
      if(brandAvatarImg){
        if(u2){ brandAvatarImg.src = u2; brandAvatarImg.style.display='block'; }
        else { brandAvatarImg.removeAttribute('src'); brandAvatarImg.style.display='none'; }
      }
      if(brandAvatarPh){ brandAvatarPh.style.display = u2 ? 'none' : 'inline'; }

      // header: address (primary) + name (secondary)
      if(headerPrimary){
        headerPrimary.textContent = addr ? addr : 'üìç ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
        headerPrimary.classList.toggle('cust-header-link', true);
      }
      if(headerSecondary){
        headerSecondary.textContent = (j.user && j.user.name) ? String(j.user.name || '') : '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤';
      }

      // Autofill booking form (only fill empty fields)
      try{
        const nameEl = document.getElementById('customer_name');
        const phoneEl = document.getElementById('customer_phone');
        const addrEl = document.getElementById('address_text');
        const mapsEl = document.getElementById('maps_url');
        const lineName = (j.user && j.user.name) ? String(j.user.name || '').trim() : '';

        if(nameEl && !String(nameEl.value||'').trim() && lineName) nameEl.value = lineName;
        if(phoneEl && !String(phoneEl.value||'').trim() && phoneFromProfile) phoneEl.value = phoneFromProfile;
        if(addrEl && !String(addrEl.value||'').trim() && addr) addrEl.value = addr;
        if(mapsEl && !String(mapsEl.value||'').trim() && mapsUrl) mapsEl.value = mapsUrl;
        updateMapsPreview();
        updateConfirmSummary();
      }catch(_){ /* ignore */ }

      // clicking avatar / header opens modal (if has address) else goes to register
      if(brandAvatarBtn){
        brandAvatarBtn.onclick = () => {
          if(addr) openAddressModal({ address: addr, maps_url: mapsUrl });
          else location.href = '/register?from=header';
        };
      }
      if(headerPrimary){
        headerPrimary.onclick = () => {
          if(addr) openAddressModal({ address: addr, maps_url: mapsUrl });
          else location.href = '/register?from=header';
        };
      }
    }else{
      if(loginBtn) loginBtn.style.display = 'inline-flex';
      if(regBtn) regBtn.style.display = 'none';
      if(badge) badge.style.display = 'none';

      if(menuBtn) menuBtn.style.display = 'inline-flex';
      if(logoutBtn) logoutBtn.style.display = 'none';
      if(drawerLogoutBtn) drawerLogoutBtn.style.display = 'none';

      // brand avatar placeholder
      if(brandAvatarImg){ brandAvatarImg.removeAttribute('src'); brandAvatarImg.style.display='none'; }
      if(brandAvatarPh){ brandAvatarPh.style.display='inline'; }
      if(headerPrimary){ headerPrimary.textContent = 'üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)'; headerPrimary.classList.remove('cust-header-link'); headerPrimary.onclick = null; }
      if(headerSecondary){ headerSecondary.textContent = 'Coldwindflow air services'; }
      if(brandAvatarBtn){ brandAvatarBtn.onclick = null; }
    }
  }catch(_){
    // ignore
  }
}

async function customerLogout(){
  try{
    await fetch(`${API}/public/logout`, { method:'POST', credentials:'include' });
  }catch(_){
    // fallback
    try{ location.href = '/public/logout'; return; }catch(e){}
  }
  try{ location.href = '/customer.html?logout=1'; }catch(_){ location.reload(); }
}

// Address modal (view/edit)
function openAddressModal(p){
  const modal = document.getElementById('addr_modal');
  const addrView = document.getElementById('addr_view');
  const addrEdit = document.getElementById('addr_edit');
  const addrText = document.getElementById('addr_text');
  const mapsOpen = document.getElementById('addr_maps_open');
  const addrInput = document.getElementById('addr_input');
  const mapsInput = document.getElementById('maps_input');
  const saveRes = document.getElementById('addr_save_result');
  if(!modal) return;

  const address = String(p?.address || '').trim();
  const mapsUrl = String(p?.maps_url || '').trim();
  if(addrText) addrText.textContent = address || '-';
  if(mapsOpen){
    if(mapsUrl){ mapsOpen.href = mapsUrl; mapsOpen.style.display = 'inline-flex'; }
    else { mapsOpen.href = '#'; mapsOpen.style.display = 'none'; }
  }
  if(addrInput) addrInput.value = address;
  if(mapsInput) mapsInput.value = mapsUrl;
  if(saveRes) saveRes.textContent = '';

  if(addrView) addrView.style.display = 'block';
  if(addrEdit) addrEdit.style.display = 'none';
  modal.style.display = 'block';
  modal.setAttribute('aria-hidden','false');
}

function closeAddressModal(){
  const modal = document.getElementById('addr_modal');
  if(!modal) return;
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
}

async function saveAddressFromModal(){
  const addrInput = document.getElementById('addr_input');
  const mapsInput = document.getElementById('maps_input');
  const saveRes = document.getElementById('addr_save_result');
  const address = String(addrInput?.value || '').trim();
  const maps_url = String(mapsInput?.value || '').trim();
  if(address.length < 5){
    if(saveRes) saveRes.textContent = '‚ö†Ô∏è ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ';
    return;
  }
  try{
    const r = await fetch(`${API}/public/profile/address`, {
      method: 'PATCH',
      credentials: 'include',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ address, maps_url })
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok){
      const msg = j?.error ? String(j.error) : 'SAVE_FAILED';
      if(saveRes) saveRes.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg;
      return;
    }
    if(saveRes) saveRes.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    // refresh header state
    await loadMe();

    // also fill booking form address fields (so customer doesn't need to retype)
    try{
      const addrEl = document.getElementById('address_text');
      const mapsEl = document.getElementById('maps_url');
      if(addrEl) addrEl.value = address;
      if(mapsEl) mapsEl.value = maps_url;
      updateMapsPreview();
      updateConfirmSummary();
    }catch(_){ /* ignore */ }
    // update view
    const addrText = document.getElementById('addr_text');
    const mapsOpen = document.getElementById('addr_maps_open');
    if(addrText) addrText.textContent = address;
    if(mapsOpen){
      if(maps_url){ mapsOpen.href = maps_url; mapsOpen.style.display = 'inline-flex'; }
      else { mapsOpen.href = '#'; mapsOpen.style.display = 'none'; }
    }
    // switch to view
    const addrView = document.getElementById('addr_view');
    const addrEdit = document.getElementById('addr_edit');
    if(addrView) addrView.style.display = 'block';
    if(addrEdit) addrEdit.style.display = 'none';
  }catch(e){
    if(saveRes) saveRes.textContent = '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
  }
}

function showTopNoticeFromUrl(){
  try{
    const p = new URLSearchParams(location.search || '');
    const el = document.getElementById('result');

    // ---- login/logout notice (toast + debug) ----
    const login = String(p.get('login') || '').trim();
    const reason = String(p.get('reason') || '').trim();
    const logout = String(p.get('logout') || '').trim();
    if (logout === '1') {
      try{ toast('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'); }catch(_){ }
      try{ window.__cwfDbg && window.__cwfDbg.log('logout=1'); }catch(_){ }
    }
    if (login === 'success') {
      try{ toast('Login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ'); }catch(_){ }
      try{ window.__cwfDbg && window.__cwfDbg.log('login=success'); }catch(_){ }
    }
    if (login === 'failed') {
      const msg = reason ? `Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${reason})` : 'Login ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      try{ toast(msg); }catch(_){ }
      try{ window.__cwfDbg && window.__cwfDbg.open(); window.__cwfDbg.log('login=failed', { reason }); }catch(_){ }
    }

    // ---- register notice (existing behavior) ----
    const v = String(p.get('register') || '').trim();
    if(!v || !el) return;
    if(v === 'success') {
      el.innerHTML = '<div class="card" style="padding:12px;border:1px solid rgba(15,23,42,0.12);">‚úÖ <b>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</b><div class="muted" style="margin-top:4px;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</div></div>';
    } else if(v === 'need_login') {
      el.innerHTML = '<div class="card" style="padding:12px;border:1px solid rgba(15,23,42,0.12);">‚ö†Ô∏è <b>‡∏ï‡πâ‡∏≠‡∏á Login ‡∏Å‡πà‡∏≠‡∏ô</b><div class="muted" style="margin-top:4px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î Login ‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏î Register</div></div>';
    }
  } catch(_) {}
}

let pickedTime = null;
let standardPrice = 0;
let durationMin = 60;

// Slot filter (default: available only)
let slotFilterMode = 'avail'; // 'avail' | 'all'
let lastSlotsResp = null;     // cache last availability response

// PATCH: machine count stepper
function bindMachineCountStepper(){
  const input = document.getElementById('machine_count');
  const minus = document.getElementById('mc_minus');
  const plus = document.getElementById('mc_plus');
  if(!input || !minus || !plus) return;
  const set = async (n)=>{
    const v = Math.max(1, Math.min(20, Number(n)||1));
    input.value = String(v);
    showVariantFields();
    await refreshPricing();
    updateLoadSlotsEnabled();
  };
  minus.addEventListener('click', ()=> set(Number(input.value||1)-1));
  plus.addEventListener('click', ()=> set(Number(input.value||1)+1));
  input.addEventListener('change', ()=> set(Number(input.value||1)));
  set(input.value||1);
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏≠‡∏ï: ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" (UX ‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
// ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏à‡∏∞‡πÑ‡∏õ‡∏ó‡∏≥‡πÉ‡∏ô loadSlots() ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏†‡∏≤‡∏û
function isBookingFormReadyForSlots() {
  const d = document.getElementById("date")?.value;
  return !!d;
}

function updateLoadSlotsEnabled() {
  const btn = document.getElementById("loadSlotsBtn");
  if (!btn) return;
  btn.disabled = !isBookingFormReadyForSlots();
}

// promos (customer)
let promotionsCustomer = [];

function calcDiscount(subtotal, promo) {
  if (!promo) return 0;
  const v = Number(promo.promo_value || 0);
  if (promo.promo_type === "percent") return subtotal * (Math.max(0, v) / 100);
  if (promo.promo_type === "amount") return Math.max(0, v);
  return 0;
}

function getSelectedPromoCustomer() {
  const promoId = document.getElementById("promotion_select_customer")?.value || "";
  return promotionsCustomer.find(p => String(p.promo_id) === String(promoId)) || null;
}

function promoMatchesPayloadCustomer(promo, payload){
  if(!promo) return false;
  const isBlank = (v)=> v === undefined || v === null || String(v).trim()==='';

  if(!isBlank(promo.job_type) && String(promo.job_type).trim() !== String(payload.job_type||'').trim()) return false;
  if(!isBlank(promo.ac_type) && String(promo.ac_type).trim() !== String(payload.ac_type||'').trim()) return false;

  const btu = Number(payload.btu || 0);
  const bmin = isBlank(promo.btu_min) ? null : Number(promo.btu_min);
  const bmax = isBlank(promo.btu_max) ? null : Number(promo.btu_max);
  if(Number.isFinite(bmin) && bmin !== null && btu && btu < bmin) return false;
  if(Number.isFinite(bmax) && bmax !== null && btu && btu > bmax) return false;

  const mc = Number(payload.machine_count || 1);
  const mmin = isBlank(promo.machine_min) ? null : Number(promo.machine_min);
  const mmax = isBlank(promo.machine_max) ? null : Number(promo.machine_max);
  if(Number.isFinite(mmin) && mmin !== null && mc < mmin) return false;
  if(Number.isFinite(mmax) && mmax !== null && mc > mmax) return false;

  if(String(payload.job_type||'').trim()==='‡∏•‡πâ‡∏≤‡∏á'){
    if(!isBlank(promo.wash_variant) && String(promo.wash_variant).trim() !== String(payload.wash_variant||'').trim()) return false;
  }

  return true;
}

// ============================
// Multi-service lines (customer)
// ============================
let serviceLinesCustomer = []; // each: { job_type, ac_type, btu, machine_count, wash_variant, repair_variant }

function getSingleServiceSelection(){
  const job_type = document.getElementById("job_type").value.trim();
  const ac_type = document.getElementById("ac_type").value.trim();
  const btu = Number(document.getElementById("btu").value || 0);
  const machine_count = Math.max(1, Number(document.getElementById("machine_count").value || 1));
  const wash_variant = document.getElementById("wash_variant").value.trim();
  const repair_variant = document.getElementById("repair_variant").value.trim();
  return { job_type, ac_type, btu, machine_count, wash_variant, repair_variant };
}

function aggFromServices(services){
  const norm = (s)=> String(s||'').trim();
  const allSame = (arr)=> arr.length && arr.every(v=>v===arr[0]);
  const job_types = services.map(s=>norm(s.job_type));
  const ac_types = services.map(s=>norm(s.ac_type));
  const wash_vars = services.map(s=>norm(s.wash_variant));
  const rep_vars = services.map(s=>norm(s.repair_variant));
  const btus = services.map(s=>Number(s.btu||0)).filter(n=>n>0);
  const mcs = services.map(s=>Number(s.machine_count||1));

  const job_type = allSame(job_types) ? job_types[0] : "";
  const ac_type = allSame(ac_types) ? ac_types[0] : "";
  const wash_variant = allSame(wash_vars) ? wash_vars[0] : "";
  const repair_variant = allSame(rep_vars) ? rep_vars[0] : "";
  const btu = btus.length && btus.every(v=>v===btus[0]) ? btus[0] : (btus.length ? Math.max(...btus) : 0);
  const machine_count = mcs.reduce((a,b)=>a+Math.max(1,Number(b||1)),0);

  return { job_type, ac_type, btu, machine_count, wash_variant, repair_variant };
}

function renderServiceLinesCustomer(){
  const box = document.getElementById('service_lines_customer');
  const wrap = document.getElementById('multi_service_box_customer');
  if(!box || !wrap) return;

  wrap.style.display = serviceLinesCustomer.length ? 'block' : 'none';
  if(!serviceLinesCustomer.length){
    box.innerHTML = '<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‚Äù</div>';
    return;
  }

  box.innerHTML = serviceLinesCustomer.map((s, idx)=>{
    const parts = [];
    if(s.job_type) parts.push(s.job_type);
    if(s.ac_type) parts.push(s.ac_type);
    if(s.btu) parts.push(`${Number(s.btu).toLocaleString('th-TH')} BTU`);
    parts.push(`${Number(s.machine_count||1)} ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á`);
    if(String(s.job_type).trim()==='‡∏•‡πâ‡∏≤‡∏á' && s.wash_variant) parts.push(s.wash_variant);
    if(String(s.job_type).trim()==='‡∏ã‡πà‡∏≠‡∏°' && s.repair_variant) parts.push(s.repair_variant);

    return `
      <div class="svc-line">
        <div class="svc-line-main">
          <b>${parts.join(' ‚Ä¢ ')}</b>
          <div class="muted" style="font-size:12px;margin-top:2px;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ${idx+1}</div>
        </div>
        <button type="button" class="danger svc-line-del" onclick="removeServiceLineCustomer(${idx})">‡∏•‡∏ö</button>
      </div>
    `;
  }).join('');
}

function removeServiceLineCustomer(idx){
  serviceLinesCustomer.splice(idx, 1);
  renderServiceLinesCustomer();
  refreshPricing();
}

function clearServiceLinesCustomer(){
  serviceLinesCustomer = [];
  renderServiceLinesCustomer();
  refreshPricing();
}

function addServiceLineCustomerFromCurrent(){
  const cur = getSingleServiceSelection();
  if(!cur.job_type) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
  if(!cur.ac_type) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô');
  if(!cur.btu) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BTU ‡∏Å‡πà‡∏≠‡∏ô');
  if(cur.job_type==='‡∏•‡πâ‡∏≤‡∏á' && cur.ac_type==='‡∏ú‡∏ô‡∏±‡∏á' && !cur.wash_variant) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô');
  if(cur.job_type==='‡∏ã‡πà‡∏≠‡∏°' && !cur.repair_variant) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ã‡πà‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô');

  serviceLinesCustomer.push(cur);
  renderServiceLinesCustomer();
  refreshPricing();
}

function autoPickPromotionCustomer(){
  const ps = document.getElementById('promotion_select_customer');
  if(!ps) return;
  const payload = getPayloadV2();

  if(!payload.job_type || !payload.ac_type || !payload.btu || !payload.machine_count){
    ps.value = '';
    return;
  }
  if(payload.job_type === '‡∏•‡πâ‡∏≤‡∏á' && payload.ac_type === '‡∏ú‡∏ô‡∏±‡∏á' && !payload.wash_variant){
    ps.value = '';
    return;
  }

  const subtotal = Number(standardPrice || 0);
  const candidates = (promotionsCustomer||[]).filter(p => promoMatchesPayloadCustomer(p, payload));
  if(!candidates.length){
    ps.value = '';
    return;
  }

  const best = candidates
    .map(p => ({ p, discount: Math.min(subtotal, calcDiscount(subtotal, p)), prio: Number(p.priority || 0), id: Number(p.promo_id||0) }))
    .sort((a,b)=> (b.discount-a.discount) || (b.prio-a.prio) || (b.id-a.id))[0];

  ps.value = best?.p ? String(best.p.promo_id) : '';
}

function recomputeGrandTotal() {
  const subtotal = Number(standardPrice || 0);
  const total = Math.max(0, subtotal);
  const totalBox = document.getElementById("grand_total");
  if (totalBox) totalBox.textContent = total.toFixed(0);

  updateConfirmSummary();
}

function getPayloadV2(){
  if (Array.isArray(serviceLinesCustomer) && serviceLinesCustomer.length){
    const agg = aggFromServices(serviceLinesCustomer);
    return { services: serviceLinesCustomer, ...agg };
  }
  return getSingleServiceSelection();
}

function updateWashOptionsByAcType(){
  const ac_type = document.getElementById("ac_type").value.trim();
  const wash = document.getElementById("wash_variant");
  if(!wash) return;

  const prev = (wash.value || '').trim();

  // Wall type: full options (4 ‡πÅ‡∏ö‡∏ö)
  if(!ac_type || ac_type === '‡∏ú‡∏ô‡∏±‡∏á'){
    wash.innerHTML = `
      <option value="‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤">‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
      <option value="‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°">‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</option>
      <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏•‡πå</option>
      <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á">‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏ç‡πà</option>
    `.trim();
    if(prev && Array.from(wash.options).some(o=>o.value===prev)) wash.value = prev;
    else wash.value = '‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤';
    return;
  }

  // Non-wall types: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á
  wash.innerHTML = '';
  wash.value = '';
}

function showVariantFields(){
  const job_type = document.getElementById("job_type").value.trim();
  const ac_type = document.getElementById("ac_type").value.trim();
  const wash = document.getElementById("wash_variant");
  const rep = document.getElementById("repair_variant");
  const vb = document.getElementById('variant_box_customer');
  const rb = document.getElementById('repair_box_customer');

  updateWashOptionsByAcType();

  // ‡πÅ‡∏™‡∏î‡∏á ‚Äú‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‚Äù ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ (‡∏•‡πâ‡∏≤‡∏á + ‡∏ú‡∏ô‡∏±‡∏á)
  const showWash = (job_type === '‡∏•‡πâ‡∏≤‡∏á' && ac_type === '‡∏ú‡∏ô‡∏±‡∏á');
  if(vb) vb.style.display = showWash ? 'block' : 'none';
  if(!showWash && wash){ wash.value = ''; }

  // ‡∏ã‡πà‡∏≠‡∏°: ‡πÅ‡∏™‡∏î‡∏á repair box
  const showRepair = (job_type === '‡∏ã‡πà‡∏≠‡∏°');
  if(rb) rb.style.display = showRepair ? 'block' : 'none';
  if(rep) rep.style.display = showRepair ? 'block' : 'none';
}

async function refreshPricing(){
  const payload = getPayloadV2();
  const sp = document.getElementById("standard_price");
  const dm = document.getElementById("duration_min");

  // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ ‚Üí reset
  if(!payload.job_type && !(payload.services && payload.services.length)){
    standardPrice = 0; durationMin = 60;
    sp.textContent = "-"; dm.textContent = "-";
    return;
  }

  try{
    const r = await fetch(`${API}/public/pricing_preview`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    standardPrice = Number(data.standard_price || 0);
    durationMin = Number(data.duration_min || 60);

    sp.textContent = standardPrice.toFixed(0);
    dm.textContent = durationMin.toFixed(0);
  }catch(e){
    // ‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà/‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Üí ‡πÅ‡∏™‡∏î‡∏á - ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)
    standardPrice = 0; durationMin = 60;
    sp.textContent = "-";
    dm.textContent = "-";
    console.warn(e);
  } finally {
    // promo auto-pick (customer cannot choose)
    autoPickPromotionCustomer();
    recomputeGrandTotal();
  }
}

function setPicked(time){
  pickedTime = time;
  document.getElementById("picked").textContent = time || "-";
  // toggle selected style (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reload)
  document.querySelectorAll('#slots .slot-chip').forEach(b=>b.classList.remove('selected'));
  if (time) {
    const btn = Array.from(document.querySelectorAll('#slots .slot-chip')).find(b=> String(b.dataset.start||'') === String(time));
    if (btn) btn.classList.add('selected');
  }
  updateConfirmSummary();
}

function setSlotFilterMode(mode){
  slotFilterMode = (mode === 'all') ? 'all' : 'avail';
  const a = document.getElementById('filter_avail');
  const b = document.getElementById('filter_all');
  if(a && b){
    const isAvail = slotFilterMode === 'avail';
    a.classList.toggle('active', isAvail);
    b.classList.toggle('active', !isAvail);
    a.setAttribute('aria-selected', isAvail ? 'true' : 'false');
    b.setAttribute('aria-selected', !isAvail ? 'true' : 'false');
  }
  if(lastSlotsResp) renderSlotsFromCache();
}

function renderSlotsFromCache(){
  const slotsBox = document.getElementById('slots');
  if(!slotsBox || !lastSlotsResp) return;
  const data = lastSlotsResp;
  const slotsAll = (data.slots || []).filter(Boolean);
  const slotsAvail = slotsAll.filter(s=>!!s.available);
  const list = (slotFilterMode === 'all') ? slotsAll : slotsAvail;

  // if current picked time is filtered out ‚Üí reset
  if(pickedTime && !list.some(s=>String(s.start)===String(pickedTime))) setPicked(null);

  const head = `<div class="slot-head">
    <div class="muted">‡πÇ‡∏´‡∏°‡∏î: <b>${data.tech_type==='partner'?'‡∏î‡πà‡∏ß‡∏ô (‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)':'‡∏õ‡∏Å‡∏ï‡∏¥'}</b></div>
    <div class="badge ${slotsAvail.length? 'ok':'muted'}">${slotsAvail.length? '‡∏ß‡πà‡∏≤‡∏á':'‡πÄ‡∏ï‡πá‡∏°'} ‚Ä¢ ${slotsAvail.length}/${slotsAll.length}</div>
  </div>`;

  if(!list.length){
    slotsBox.innerHTML = head + `<div class="muted" style="margin-top:10px;">${slotFilterMode==='avail' ? '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤'}</div>`;
    return;
  }

  const chips = list.map(s=>{
    const full = !s.available;
    const cls = `slot-chip ${s.available? 'is-available':'is-full'} ${pickedTime===s.start? 'selected':''}`;
    const disabled = full ? 'disabled' : '';
    const meta = s.available ? `‡∏ß‡πà‡∏≤‡∏á` : '‡πÄ‡∏ï‡πá‡∏°';
    return `<button type="button" class="${cls}" data-start="${s.start}" ${disabled} onclick="setPicked('${s.start}')">
      <span class="t">${s.start}</span>
      <span class="m">${meta}</span>
    </button>`;
  }).join('');

  slotsBox.innerHTML = head + `<div class="slot-chip-wrap" style="margin-top:10px;">${chips}</div>`;
}

async function loadSlots(){
  // log action in debug panel (if available)
  try{ window.__cwfDbg && window.__cwfDbg.log('loadSlots() clicked'); }catch(_){ }
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  setPicked(null);

  const slotsBox = document.getElementById("slots");
  const controls = document.getElementById('slot_controls');
  if(controls) controls.style.display = 'none';
  slotsBox.innerHTML = `<div class="slot-skeleton">
    <div class="sk-line"></div>
    <div class="sk-chips">
      ${Array.from({length:10}).map(()=>'<div class="sk-chip"></div>').join('')}
    </div>
  </div>`;

  const payload = getPayloadV2();
  // ‚úÖ ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏ß‡πà‡∏≤‡∏á
  const validateOne = (p)=>{
    if (!p.job_type || !p.ac_type || !p.btu || !p.machine_count) return false;
    if (p.job_type === '‡∏•‡πâ‡∏≤‡∏á' && p.ac_type === '‡∏ú‡∏ô‡∏±‡∏á' && !p.wash_variant) return false;
    if (p.job_type === '‡∏ã‡πà‡∏≠‡∏°' && !p.repair_variant) return false;
    return true;
  };

  // helper: ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ user ‡∏á‡∏á‡∏ß‡πà‡∏≤ ‚Äú‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‚Äù) 
  const missingFields = (p)=>{
    const miss = [];
    if(!p.job_type) miss.push('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô');
    if(!p.ac_type) miss.push('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå');
    if(!p.btu) miss.push('BTU');
    if(!p.machine_count) miss.push('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
    if(p.job_type === '‡∏•‡πâ‡∏≤‡∏á' && p.ac_type === '‡∏ú‡∏ô‡∏±‡∏á' && !p.wash_variant) miss.push('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á');
    if(p.job_type === '‡∏ã‡πà‡∏≠‡∏°' && !p.repair_variant) miss.push('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°');
    return miss;
  };

  if(payload.services && Array.isArray(payload.services) && payload.services.length){
    const badIdx = payload.services.findIndex(p=>!validateOne(p));
    if(badIdx !== -1){
      const miss = missingFields(payload.services[badIdx] || {});
      slotsBox.textContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö ‚Äú‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ${badIdx+1}‚Äù (${miss.join('/') || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'}) ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á`;
      return;
    }
  }else{
    if(!validateOne(payload)){
      const miss = missingFields(payload);
      slotsBox.textContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô (${miss.join('/') || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'})`;
      return;
    }
  }

  await refreshPricing(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï durationMin ‡∏Å‡πà‡∏≠‡∏ô

  const duration_min = Number(durationMin || 60);
  const urgent = document.getElementById("urgent_toggle").checked;
  const tech_type = urgent ? "partner" : "company";

  // ‡∏™‡πà‡∏á criteria ‡πÑ‡∏õ‡πÉ‡∏´‡πâ server filter ‡∏ï‡∏≤‡∏° service matrix (Option B)
  let url = `${API}/public/availability_v2?date=${encodeURIComponent(d)}&tech_type=${encodeURIComponent(tech_type)}&duration_min=${encodeURIComponent(duration_min)}`;
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Debug Panel ‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏Ç‡∏≠ debug reasons ‡∏à‡∏≤‡∏Å backend
  try{
    const dbgOpen = (document.getElementById('cust_debug_panel')?.style.display === 'block');
    if(dbgOpen) url += '&debug=1&include_full=1';
  }catch(_){ }
  if(payload.services && Array.isArray(payload.services) && payload.services.length){
    url += `&services=${encodeURIComponent(JSON.stringify(payload.services))}`;
  }else{
    url += `&job_type=${encodeURIComponent(payload.job_type||'')}`
      + `&ac_type=${encodeURIComponent(payload.ac_type||'')}`
      + `&wash_variant=${encodeURIComponent(payload.wash_variant||'')}`
      + `&repair_variant=${encodeURIComponent(payload.repair_variant||'')}`;
  }

  try{
    try{ window.__cwfDbg && window.__cwfDbg.log('‚Üí fetch availability_v2', { url }); }catch(_){ }
    const r = await fetch(url, { credentials: 'include' });
    const ct = (r.headers.get('content-type')||'').toLowerCase();
    const isJson = ct.includes('application/json') || ct.includes('+json');
    const raw = await r.text();
    const data = isJson ? (JSON.parse(raw||'{}')) : null;
    if(!r.ok){
      const msg = (data && data.error) ? data.error : (raw || `HTTP ${r.status}`);
      throw new Error(msg);
    }
    if(!data || typeof data !== 'object') throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    if(data.error) throw new Error(data.error);
    if(!data.slots || !data.slots.length){
      const reason = (data && data.debug && data.debug.reasons && data.debug.reasons.length)
        ? (' | reason=' + data.debug.reasons.map(x=>x.code).join(','))
        : '';
      slotsBox.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤" + reason;
      try{ window.__cwfDbg && window.__cwfDbg.log('‚Üê no slots', data); }catch(_){ }
      return;
    }
    lastSlotsResp = data;
    if(controls) controls.style.display = 'block';
    renderSlotsFromCache();
    try{ window.__cwfDbg && window.__cwfDbg.log('‚Üê slots ok', { count: (data.slots||[]).length }); }catch(_){ }
  }catch(e){
    const msg = (e && e.message) ? String(e.message) : 'Unknown error';
    slotsBox.textContent = `‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${msg}`;
    console.error(e);
    try{ window.__cwfDbg && window.__cwfDbg.log('‚ùå loadSlots error', msg); }catch(_){ }
  }
}

async function book(){
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  if(!pickedTime) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô");

  const customer_name = document.getElementById("customer_name").value.trim();
  const customer_phone = document.getElementById("customer_phone").value.trim();
  const job_type = document.getElementById("job_type").value.trim();
  const address_text = document.getElementById("address_text").value.trim();
  const maps_url = document.getElementById("maps_url").value.trim();
  const customer_note = document.getElementById("customer_note").value.trim();

  // ‚úÖ ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ñ‡πâ‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Maps (‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á)
  if(maps_url && !isValidMapsUrl(maps_url)){
    toast('‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Google Maps (‡∏¢‡∏±‡∏á‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ)');
  }

  if(!customer_name || !job_type || !address_text){
    return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)");
  }

  const appointment_datetime = `${d}T${pickedTime}:00`;

  const payload = getPayloadV2();
  const urgent = document.getElementById("urgent_toggle").checked;

  const body = {
    customer_name, customer_phone, job_type,
    appointment_datetime, address_text, maps_url, customer_note,
    booking_mode: urgent ? "urgent" : "scheduled",promotion_id: (document.getElementById("promotion_select_customer")?.value || null) || null,
    ...payload
  };

  const confirmBtn = document.getElementById('confirm_btn');
  if(confirmBtn){ confirmBtn.disabled = true; confirmBtn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≠‡∏á...'; }

  fetch(`${API}/public/book`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(body)
  })
  .then(async r=>{
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return data;
  })
  .then(data=>{
    const box = document.getElementById("result");
    const token = data.token;
    const code = data.booking_code || token || '';
    const trackUrl = `${API}/track.html?q=${encodeURIComponent(code)}`;
    box.innerHTML = `<div class="success-card">
      <div class="success-title">‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
      <div class="success-row"><span class="k">‡πÄ‡∏•‡∏Ç Booking/Tracking</span><span class="v"><b style="font-size:18px;">${code || '-'}</b></span></div>
      <div class="success-row"><span class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span><span class="v">${data.booking_mode==='urgent' ? '‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' : '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span></div>
      <div class="success-row"><span class="k">‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span><span class="v">${data.duration_min || '-'} ‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
      <div class="success-actions">
        <button type="button" class="secondary action-btn" onclick="copyText('${code.replace(/'/g,"\\'")}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç</button>
        <button type="button" class="secondary action-btn" onclick="shareLine('${code.replace(/'/g,"\\'")}')">üí¨ ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ LINE</button>
        <button type="button" class="secondary action-btn" onclick="downloadIcsForBooking()">üìÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô</button>
        <button type="button" class="secondary action-btn" onclick="location.href='${trackUrl}'">üîé ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>`;

    // stash for calendar button (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö flow ‡πÄ‡∏î‡∏¥‡∏°)
    window.__lastBookingForIcs = {
      code,
      date: document.getElementById('date')?.value || '',
      time: pickedTime || '',
      duration_min: Number(data.duration_min || durationMin || 60),
      address: (document.getElementById('address_text')?.value || '').trim(),
      maps_url: (document.getElementById('maps_url')?.value || '').trim(),
      track_url: trackUrl
    };
  })
  .catch(e=>{
    alert(`‚ùå ${e.message}`);
  })
  .finally(()=>{
    if(confirmBtn){ confirmBtn.disabled = false; confirmBtn.textContent = '‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á'; }
  });
}

async function copyText(t){
  try{
    if(!t) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(String(t));
    } else {
      const ta = document.createElement('textarea');
      ta.value = String(t);
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
    }
    toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }catch(_){
    toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function toast(msg){
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(()=> el.classList.add('show'), 10);
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 250); }, 1600);
}

function shareLine(code){
  try{
    const c = String(code||'').trim();
    if(!c) return;
    const trackUrl = `${API}/track.html?q=${encodeURIComponent(c)}`;
    const msg = `‡πÄ‡∏•‡∏Ç Booking: ${c}\n‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô: ${trackUrl}`;
    // ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (LINE app ‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠)
    const u = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
    window.open(u, '_blank', 'noopener');
  }catch(_){
    toast('‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

function toIcsDate(dt){
  // dt = Date object (local). format: YYYYMMDDTHHMMSS
  const pad = (n)=> String(n).padStart(2,'0');
  return `${dt.getFullYear()}${pad(dt.getMonth()+1)}${pad(dt.getDate())}T${pad(dt.getHours())}${pad(dt.getMinutes())}${pad(dt.getSeconds())}`;
}

function downloadIcsForBooking(){
  try{
    const b = window.__lastBookingForIcs;
    if(!b || !b.date || !b.time){
      toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢');
      return;
    }
    const [hh, mm] = String(b.time).split(':').map(x=>Number(x||0));
    const start = new Date(`${b.date}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`);
    const end = new Date(start.getTime() + (Number(b.duration_min||60) * 60000));
    const uid = `CWF-${String(b.code||'').replace(/\s+/g,'')}-${Date.now()}@cwf-air.com`;
    const title = `CWF ‡∏ô‡∏±‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (${b.code||'Booking'})`;
    const loc = (b.address||'') + (b.maps_url ? ` (${b.maps_url})` : '');
    const desc = `‡πÄ‡∏•‡∏Ç Booking: ${b.code||''}\n‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô: ${b.track_url||''}`;
    const ics = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//CWF//Booking//TH',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${toIcsDate(new Date())}`,
      `DTSTART:${toIcsDate(start)}`,
      `DTEND:${toIcsDate(end)}`,
      `SUMMARY:${title}`,
      `LOCATION:${loc.replace(/\n/g,' ')}`,
      `DESCRIPTION:${desc.replace(/\n/g,'\\n')}`,
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\r\n');
    const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CWF-${String(b.code||'booking')}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 1500);
    toast('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ');
  }catch(_){
    toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  }
}

// listeners
["job_type","ac_type","btu","wash_variant","repair_variant"].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener("change", async ()=>{
    showVariantFields();
    await refreshPricing();
    updateLoadSlotsEnabled();
  });
});

// (menu handlers are defined at the end of file)
document.getElementById("urgent_toggle")?.addEventListener("change", ()=>{ /* slots refresh optional */ });
document.getElementById("date")?.addEventListener("change", ()=>{ updateLoadSlotsEnabled(); });

async function initCustomerCatalogAndPromos(){
  try{
    const proR = await fetch(`${API}/promotions?customer=1`).then(r=>r.json()).catch(()=>[]);
    promotionsCustomer = Array.isArray(proR) ? proR : (proR.promotions || []);

    const ps = document.getElementById("promotion_select_customer");
    if (ps) {
      ps.innerHTML = `<option value="">-- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£ --</option>` +
        promotionsCustomer.map(p => {
          const label = p.promo_type === "percent" ? `-${Number(p.promo_value)}%` : `-${Number(p.promo_value)} ‡∏ö‡∏≤‡∏ó`;
          return `<option value="${p.promo_id}">${p.promo_name} (${label})</option>`;
        }).join("");
      ps.disabled = true;
      ps.style.pointerEvents = 'none';
    }

    autoPickPromotionCustomer();
    recomputeGrandTotal();
  }catch(e){
    console.warn("initCustomerCatalogAndPromos", e);
  }
}

showVariantFields();
bindMachineCountStepper();

// multi-service buttons
document.getElementById('btnAddServiceLineCustomer')?.addEventListener('click', ()=> addServiceLineCustomerFromCurrent());
document.getElementById('btnClearServiceLinesCustomer')?.addEventListener('click', ()=> clearServiceLinesCustomer());

renderServiceLinesCustomer();
initCustomerCatalogAndPromos();
refreshPricing();
updateLoadSlotsEnabled();

// slot filter controls
document.getElementById('filter_avail')?.addEventListener('click', ()=> setSlotFilterMode('avail'));
document.getElementById('filter_all')?.addEventListener('click', ()=> setSlotFilterMode('all'));
setSlotFilterMode('avail');

// keep summary fresh when user types
['date','customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', ()=> updateConfirmSummary());
});

// maps helper + preview
document.getElementById('maps_help_btn')?.addEventListener('click', ()=>{
  const pop = document.getElementById('maps_pop');
  if(!pop) return;
  pop.style.display = (pop.style.display === 'none' || !pop.style.display) ? 'block' : 'none';
});
document.getElementById('maps_url')?.addEventListener('input', ()=> updateMapsPreview());
document.addEventListener('click', (e)=>{
  const pop = document.getElementById('maps_pop');
  const btn = document.getElementById('maps_help_btn');
  if(!pop || !btn) return;
  if(pop.style.display !== 'none' && !pop.contains(e.target) && !btn.contains(e.target)) pop.style.display = 'none';
});
updateMapsPreview();
updateConfirmSummary();

// OPTIONAL-7: remember me (safe draft) ‚Äî only basic fields, no impact on booking flow
const CWF_FORM_DRAFT_KEY = 'cwf_customer_form_draft_v1';
function loadFormDraft(){
  try{
    const raw = localStorage.getItem(CWF_FORM_DRAFT_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    const ids = ['customer_name','customer_phone','address_text','maps_url','customer_note'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      // ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà user ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏Å
      if(!String(el.value||'').trim() && typeof d[id] === 'string') el.value = d[id];
    });
  }catch(e){ /* ignore */ }
}
let _draftTimer = null;
function saveFormDraft(){
  try{
    const d = {};
    ['customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) d[id] = String(el.value||'');
    });
    localStorage.setItem(CWF_FORM_DRAFT_KEY, JSON.stringify(d));
  }catch(e){ /* ignore */ }
}
function scheduleSaveDraft(){
  clearTimeout(_draftTimer);
  _draftTimer = setTimeout(saveFormDraft, 350);
}
['customer_name','customer_phone','address_text','maps_url','customer_note'].forEach(id=>{
  const el = document.getElementById(id);
  if(el){
    el.addEventListener('input', scheduleSaveDraft);
    el.addEventListener('change', scheduleSaveDraft);
  }
});
window.addEventListener('beforeunload', ()=>{ try{ saveFormDraft(); }catch(e){} });
loadFormDraft();
updateMapsPreview(); // refresh preview after autofill
updateConfirmSummary();

// Drawer menu (customer)
function openCustomerMenu(){
  const ov = document.getElementById('menu_overlay');
  const dr = document.getElementById('menu_drawer');
  const btn = document.getElementById('menu_btn');
  if(ov) ov.style.display = 'block';
  if(dr){ dr.style.display = 'block'; dr.setAttribute('aria-hidden','false'); }
  if(btn) btn.setAttribute('aria-expanded','true');
  document.body.style.overflow = 'hidden';
}
function closeCustomerMenu(){
  const ov = document.getElementById('menu_overlay');
  const dr = document.getElementById('menu_drawer');
  const btn = document.getElementById('menu_btn');
  if(ov) ov.style.display = 'none';
  if(dr){ dr.style.display = 'none'; dr.setAttribute('aria-hidden','true'); }
  if(btn) btn.setAttribute('aria-expanded','false');
  document.body.style.overflow = '';
}
document.getElementById('menu_btn')?.addEventListener('click', ()=>{
  const dr = document.getElementById('menu_drawer');
  const isOpen = dr && dr.style.display === 'block';
  isOpen ? closeCustomerMenu() : openCustomerMenu();
});
document.getElementById('menu_overlay')?.addEventListener('click', closeCustomerMenu);
document.getElementById('menu_close')?.addEventListener('click', closeCustomerMenu);
document.addEventListener('keydown', (e)=>{
  if(e.key !== 'Escape') return;
  try{ closeAddressModal(); }catch(_){}
  closeCustomerMenu();
});

document.getElementById('logout_btn')?.addEventListener('click', customerLogout);
document.getElementById('drawer_logout_btn')?.addEventListener('click', ()=>{ closeCustomerMenu(); customerLogout(); });

// Address modal events
document.getElementById('addr_modal_close')?.addEventListener('click', closeAddressModal);
document.getElementById('addr_modal_backdrop')?.addEventListener('click', closeAddressModal);
document.getElementById('addr_edit_btn')?.addEventListener('click', ()=>{
  const v = document.getElementById('addr_view');
  const e = document.getElementById('addr_edit');
  const res = document.getElementById('addr_save_result');
  if(res) res.textContent = '';
  if(v) v.style.display='none';
  if(e) e.style.display='block';
});
document.getElementById('addr_cancel_btn')?.addEventListener('click', ()=>{
  const v = document.getElementById('addr_view');
  const e = document.getElementById('addr_edit');
  if(v) v.style.display='block';
  if(e) e.style.display='none';
});
document.getElementById('addr_save_btn')?.addEventListener('click', saveAddressFromModal);

loadMe();
showTopNoticeFromUrl();

// PWA update toast (‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
function showSwToast(onUpdate){
  const wrap = document.getElementById('sw_toast');
  if(!wrap) return;
  wrap.classList.add('show');
  const btn = document.getElementById('sw_toast_reload');
  const close = document.getElementById('sw_toast_close');
  if(btn){ btn.onclick = ()=>{ try{ onUpdate(); }catch(e){} }; }
  if(close){ close.onclick = ()=> wrap.classList.remove('show'); }
}

// PWA: register service worker (HTTPS only)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('/sw.js').then((reg)=>{
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ worker ‡πÉ‡∏´‡∏°‡πà‡∏£‡∏≠ activate ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      function promptUpdate(worker){
        if(!worker) return;
        showSwToast(()=>{
          try{ worker.postMessage({type:'SKIP_WAITING'}); }catch(e){}
          // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å SW ‡πÉ‡∏´‡∏°‡πà activate ‡πÅ‡∏•‡πâ‡∏ß
          setTimeout(()=>location.reload(), 400);
        });
      }

      if(reg.waiting){
        promptUpdate(reg.waiting);
      }
      reg.addEventListener('updatefound', ()=>{
        const newWorker = reg.installing;
        if(!newWorker) return;
        newWorker.addEventListener('statechange', ()=>{
          if(newWorker.state === 'installed' && navigator.serviceWorker.controller){
            promptUpdate(newWorker);
          }
        });
      });
    }).catch(()=>{});
  });
}
</script>

<div id="sw_toast" class="sw-toast" aria-live="polite">
  <div class="sw-toast-card">
    <div class="sw-toast-text">
      <strong>‡∏°‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡∏°‡πà</strong>
      <span>‡∏Å‡∏î‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
    </div>
    <div class="sw-toast-actions">
      <button id="sw_toast_reload" class="sw-toast-btn primary" type="button">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
      <button id="sw_toast_close" class="sw-toast-btn ghost" type="button">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

</body>
</html>
