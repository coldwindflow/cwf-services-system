<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡πà‡∏≤‡∏á - CWF</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡πà‡∏≤‡∏á</b>
          <span class="muted">‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏π‡∏õ ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Äú‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‚Äù ‡∏Å‡πà‡∏≠‡∏ô</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button" onclick="history.back()">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div class="card">
      <h2>üìå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h2>
      <div class="muted" id="currentBox" style="margin-top:8px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>

    <div class="card">
      <h2>‚úèÔ∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h2>

      <div class="job-card" style="margin:10px 0 14px;">
        <b>üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÇ‡∏ó‡∏£ (Tracking)</b>
        <div class="muted" style="margin-top:4px;">* ‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</div>
        <label style="margin-top:8px;">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
        <input id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 098-xxx-xxxx">
        <div class="row" style="margin-top:10px;">
          <button type="button" onclick="savePhone()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</button>
        </div>
        <div id="phoneMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</label>
      <input id="full_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">

      <label style="margin-top:10px;">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</label>
      <input id="photo_file" type="file" accept="image/*">

      <p class="muted" style="margin:10px 0 0;">
        ‚úÖ ‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ: ‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏π‡∏õ<br>
        ‚ùå ‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
      </p>

      <div class="row" style="margin-top:12px;">
        <button type="button" onclick="submitRequest()">üì® ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ (‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</button>
        <button class="secondary" type="button" onclick="resetForm()">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>

      <div id="msg" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
const API = window.location.origin;
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");
if(!username || !role){ location.href="/login.html"; }

function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

async function loadCurrent(){
  try{
    const res = await fetch(`${API}/technicians/${encodeURIComponent(username)}/profile`);
    const data = await res.json();
    const box = document.getElementById("currentBox");

    const posMap = {junior:"Junior Tech", senior:"Senior Tech", lead:"Lead Tech"};
    const pos = data.position ? (posMap[data.position] || data.position) : "-";

    box.innerHTML = `
      <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b>${esc(data.username)}</b></div>
      <div>‡∏£‡∏´‡∏±‡∏™‡∏ä‡πà‡∏≤‡∏á: <b>${esc(data.technician_code || "-")}</b></div>
      <div>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <b>${esc(pos)}</b></div>
      <div>‡∏ä‡∏∑‡πà‡∏≠: <b>${esc(data.full_name || data.username)}</b></div>
      <div>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: <b>${esc(data.phone || "-")}</b></div>
      <div class="muted" style="margin-top:6px;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠: <b>${esc(data.request_status || "none")}</b></div>
    `;

    // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.getElementById("full_name").value = data.full_name || "";
    document.getElementById("phone").value = data.phone || "";
  }catch(e){
    document.getElementById("currentBox").textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

async function savePhone(){
  const phone = (document.getElementById("phone").value || "").trim();
  const box = document.getElementById("phoneMsg");
  box.textContent = "";

  try{
    const res = await fetch(`${API}/technicians/${encodeURIComponent(username)}/phone`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    box.textContent = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÅ‡∏•‡πâ‡∏ß";
    await loadCurrent();
  }catch(e){
    box.innerHTML = `<span style="color:#b91c1c;font-weight:800;">‚ùå ${esc(e.message)}</span>`;
  }
}

function resetForm(){
  document.getElementById("photo_file").value = "";
}

async function submitRequest(){
  const name = (document.getElementById("full_name").value || "").trim();
  const file = document.getElementById("photo_file").files[0];
  const msg = document.getElementById("msg");
  msg.innerHTML = "";

  if(!name && !file){
    msg.innerHTML = "<div class='muted'>‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á</div>";
    return;
  }

  const form = new FormData();
  form.append("username", username);
  if(name) form.append("full_name", name);
  if(file) form.append("photo", file);

  try{
    const res = await fetch(`${API}/profile/request`, { method:"POST", body: form });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    msg.innerHTML = "<div class='muted'>‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥)</div>";
    await loadCurrent();
    resetForm();
  }catch(e){
    msg.innerHTML = `<div style="color:#b91c1c;font-weight:800;">‚ùå ${esc(e.message)}</div>`;
  }
}

loadCurrent();
</script>
</body>
</html>
