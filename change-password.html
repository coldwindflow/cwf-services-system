<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™ - CWF</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>ğŸ”‘ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</b>
          <span class="muted">à¹€à¸à¸·à¹ˆà¸­à¸„à¸§à¸²à¸¡à¸›à¸¥à¸­à¸”à¸ à¸±à¸¢ à¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¹€à¸”à¸´à¸¡ à¹à¸¥à¸°à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ 2 à¸„à¸£à¸±à¹‰à¸‡</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button" onclick="history.back()">à¸¢à¹‰à¸­à¸™à¸à¸¥à¸±à¸š</button>
    </div>

    <div class="card">
      <h2>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰</h2>
      <div class="muted" id="who">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>
    </div>

    <div class="card">
      <h2>à¸à¸£à¸­à¸à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</h2>

      <label>à¸£à¸«à¸±à¸ªà¹€à¸”à¸´à¸¡</label>
      <input id="old_password" type="password" placeholder="à¸£à¸«à¸±à¸ªà¹€à¸”à¸´à¸¡">

      <label style="margin-top:10px;">à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ</label>
      <input id="new_password" type="password" placeholder="à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ">

      <label style="margin-top:10px;">à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ</label>
      <input id="confirm_password" type="password" placeholder="à¸à¸´à¸¡à¸à¹Œà¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡">

      <div class="row" style="margin-top:12px;">
        <button type="button" onclick="submitChange()">âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</button>
        <button class="secondary" type="button" onclick="resetForm()">à¸¥à¹‰à¸²à¸‡à¸Ÿà¸­à¸£à¹Œà¸¡</button>
      </div>

      <div id="msg" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
const API = window.location.origin;
const username = localStorage.getItem("username");
const role = localStorage.getItem("role");
if(!username || !role){ location.href = "/login.html"; }

function esc(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

document.getElementById("who").innerHTML = `à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰: <b>${esc(username)}</b> <span class="muted">(${esc(role)})</span>`;

function resetForm(){
  document.getElementById("old_password").value = "";
  document.getElementById("new_password").value = "";
  document.getElementById("confirm_password").value = "";
  document.getElementById("msg").innerHTML = "";
}

async function submitChange(){
  const old_password = (document.getElementById("old_password").value || "");
  const new_password = (document.getElementById("new_password").value || "");
  const confirm_password = (document.getElementById("confirm_password").value || "");
  const msg = document.getElementById("msg");
  msg.innerHTML = "";

  if(!old_password) return msg.innerHTML = "<div style='color:#b91c1c;font-weight:800;'>âŒ à¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¹€à¸”à¸´à¸¡</div>";
  if(!new_password) return msg.innerHTML = "<div style='color:#b91c1c;font-weight:800;'>âŒ à¸•à¹‰à¸­à¸‡à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆ</div>";
  if(new_password !== confirm_password) return msg.innerHTML = "<div style='color:#b91c1c;font-weight:800;'>âŒ à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸«à¸±à¸ªà¹ƒà¸«à¸¡à¹ˆà¹„à¸¡à¹ˆà¸•à¸£à¸‡à¸à¸±à¸™</div>";

  try{
    const res = await fetch(`${API}/auth/change-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, old_password, new_password, confirm_password })
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ");
    msg.innerHTML = "<div class='muted'>âœ… à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢</div>";
    resetForm();
  }catch(e){
    msg.innerHTML = `<div style='color:#b91c1c;font-weight:800;'>âŒ ${esc(e.message)}</div>`;
  }
}
</script>
</body>
</html>
