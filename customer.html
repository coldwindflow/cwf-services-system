<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="theme-2">
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <img src="/logo.png" alt="CWF">
        <div class="title">
          <b>üìÖ ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</b>
          <span class="muted">Coldwindflow air services</span>
        </div>
      </div>
      <button class="secondary" style="width:auto;min-height:40px;padding:10px 12px;" type="button"
        onclick="location.href='/track.html'">üîé ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>
    </div>

    <div class="card">
      <h2>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</h2>

      <div class="grid2">
        <input id="date" type="date">
        <button type="button" onclick="loadSlots()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</button>
      </div>

      <label style="display:flex;align-items:center;gap:10px;margin-top:10px;">
        <input id="urgent_toggle" type="checkbox" />
        <span><b>‡∏•‡∏≠‡∏á‡∏¢‡∏¥‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô</b> (‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô)</span>
      </label>

      <div id="slots" class="muted" style="margin-top:10px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‚Äù</div>

      <div class="muted" style="margin-top:8px;">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <b id="picked">-</b></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <h2>2) ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>

      <input id="customer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      <input id="customer_phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">

      <select id="job_type">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô --</option>
        <option value="‡∏•‡πâ‡∏≤‡∏á">‡∏•‡πâ‡∏≤‡∏á</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°">‡∏ã‡πà‡∏≠‡∏°</option>
        <option value="‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á</option>
      </select>

      <div class="grid2">
        <select id="ac_type">
          <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå --</option>
          <option value="‡∏ú‡∏ô‡∏±‡∏á">‡∏ú‡∏ô‡∏±‡∏á</option>
          <option value="‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á">‡∏™‡∏µ‡πà‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á</option>
          <option value="‡πÅ‡∏Ç‡∏ß‡∏ô">‡πÅ‡∏Ç‡∏ß‡∏ô</option>
          <option value="‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤">‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏¢‡πÉ‡∏ï‡πâ‡∏ù‡πâ‡∏≤</option>
        </select>
        <select id="btu">
          <option value="">-- BTU --</option>
          <option value="9000">9,000</option>
          <option value="12000">12,000</option>
          <option value="18000">18,000</option>
          <option value="24000">24,000</option>
          <option value="30000">30,000</option>
          <option value="36000">36,000</option>
        </select>
      </div>

      <div class="grid2">
        <input id="machine_count" type="number" step="1" min="1" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á">
        <select id="wash_variant">
          <option value="">-- ‡πÅ‡∏ö‡∏ö‡∏•‡πâ‡∏≤‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏ô‡∏±‡∏á) --</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤">‡∏•‡πâ‡∏≤‡∏á‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°">‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏£‡∏µ‡πÄ‡∏°‡∏µ‡∏¢‡∏°</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏Ç‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏¢‡∏ô‡πå</option>
          <option value="‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á">‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏î‡∏•‡πâ‡∏≤‡∏á</option>
        </select>
      </div>

      <select id="repair_subtype" style="display:none;">
        <option value="">-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏° --</option>
        <option value="‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ">‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤)</option>
      </select>

      <div class="muted" style="margin:6px 0 0;">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á): <b id="duration_preview">-</b></div>

      <input id="address_text" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)">
      <input id="maps_url" type="url" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå Google Maps (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‚Äî ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ä‡∏£‡πå‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á">
      <textarea id="customer_note" rows="3" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
<hr style="margin:14px 0;">
<h2 style="margin:0 0 8px;">3) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
<div class="muted" style="margin-bottom:8px;">
  * ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏≠‡∏£‡πå/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô + ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á<br>
  * ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏™‡πà/‡∏•‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
</div>

<select id="catalog_select">
  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>
</select>

<div class="grid2" style="margin-top:8px;">
  <input id="item_qty" type="number" step="1" min="1" value="1" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
  <button type="button" class="secondary" onclick="addItem()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>

<div id="items_preview" class="muted" style="margin-top:10px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
<p style="margin-top:10px;">üíµ <b>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</b> <span id="grand_total">0</span> ‡∏ö‡∏≤‡∏ó</p>

      <button type="button" onclick="book()" style="margin-top:10px;">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≠‡∏á</button>

      <div id="result" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
const API = window.location.origin;
let pickedTime = null;
let jobItems = [];      // [{item_id, item_name, qty, unit_price}]
let catalogItems = [];

function getFormFilters(){
  const job_category = document.getElementById("job_type")?.value?.trim() || "";
  const ac_type = document.getElementById("ac_type")?.value?.trim() || "";
  const btu = document.getElementById("btu")?.value || "";
  return { job_category, ac_type, btu };
}

async function refreshCatalog(){
  const { job_category, ac_type, btu } = getFormFilters();
  const qs = new URLSearchParams();
  qs.set("customer","1");
  if(job_category) qs.set("job_category", job_category);
  if(ac_type) qs.set("ac_type", ac_type);
  if(btu) qs.set("btu", btu);
  try{
    const r = await fetch(`${API}/catalog/items?${qs.toString()}`);
    const items = await r.json();
    catalogItems = Array.isArray(items) ? items : [];
    const cs = document.getElementById("catalog_select");
    if(!cs) return;
    cs.innerHTML = `<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ --</option>`;
    catalogItems.forEach(it=>{
      const opt = document.createElement("option");
      opt.value = it.item_id;
      opt.textContent = `${it.item_name} (${Number(it.base_price)} ‡∏ö‡∏≤‡∏ó/${it.unit_label})`;
      cs.appendChild(opt);
    });
  }catch(e){
    // ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÑ‡∏ß‡πâ
  }
}

async function refreshDurationPreview(){
  const el = document.getElementById("duration_preview");
  if(!el) return;

  const payload = buildDurationPayload();
  if(!payload) { el.textContent = "-"; return; }

  try{
    const r = await fetch(`${API}/public/compute-duration`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    const dmin = data.duration_min;
    const eff = data.effective_block_min;
    el.textContent = `${dmin} ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ä‡∏ô ${data.travel_buffer_min} = ${eff} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
  }catch(e){
    el.textContent = "-";
  }
}

function onJobTypeChange(){
  const jt = document.getElementById("job_type")?.value || "";
  const rs = document.getElementById("repair_subtype");
  if(rs) rs.style.display = (jt === "‡∏ã‡πà‡∏≠‡∏°") ? "block" : "none";
  refreshCatalog();
  refreshDurationPreview();
}

function buildDurationPayload(){
  const job_type = document.getElementById("job_type")?.value?.trim() || "";
  if(!job_type) return null;
  const ac_type = document.getElementById("ac_type")?.value?.trim() || "";
  const wash_variant = document.getElementById("wash_variant")?.value?.trim() || "";
  const repair_subtype = document.getElementById("repair_subtype")?.value?.trim() || "";
  const machine_count = Number(document.getElementById("machine_count")?.value || 1);
  return {
    job_type,
    job_category: job_type,
    ac_type,
    wash_variant,
    repair_subtype,
    machine_count
  };
}

// init
document.getElementById("job_type")?.addEventListener("change", onJobTypeChange);
document.getElementById("ac_type")?.addEventListener("change", () => { refreshCatalog(); refreshDurationPreview(); });
document.getElementById("btu")?.addEventListener("change", refreshCatalog);
document.getElementById("wash_variant")?.addEventListener("change", refreshDurationPreview);
document.getElementById("repair_subtype")?.addEventListener("change", refreshDurationPreview);
document.getElementById("machine_count")?.addEventListener("input", refreshDurationPreview);

refreshCatalog();
refreshDurationPreview();

function addItem(){
  const id = Number(document.getElementById("catalog_select").value);
  const qty = Number(document.getElementById("item_qty").value || 1);
  if(!id) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô");
  if(qty <= 0) return alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0");

  const found = catalogItems.find(x => Number(x.item_id) === id);
  if(!found) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");

  const existed = jobItems.find(x => Number(x.item_id) === id);
  if(existed) existed.qty += qty;
  else jobItems.push({ item_id: found.item_id, item_name: found.item_name, qty, unit_price: Number(found.base_price||0) });

  renderItems();
}

function removeItem(id){
  jobItems = jobItems.filter(x => Number(x.item_id) !== Number(id));
  renderItems();
}

function renderItems(){
  const box = document.getElementById("items_preview");
  const totalBox = document.getElementById("grand_total");
  if(!box || !totalBox) return;

  if(!jobItems.length){
    box.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
    totalBox.textContent = "0";
    return;
  }

  let total = 0;
  const html = jobItems.map(it=>{
    const line = Number(it.qty||0)*Number(it.unit_price||0);
    total += line;
    return `<div style="display:flex;justify-content:space-between;gap:10px;margin:6px 0;">
      <div>‚Ä¢ ${it.item_name} x${it.qty}</div>
      <div>
        <b>${line.toFixed(0)}</b> ‡∏ö‡∏≤‡∏ó
        <button type="button" class="danger" style="width:auto;min-height:34px;padding:6px 10px;margin-left:8px;"
          onclick="removeItem(${it.item_id})">‡∏•‡∏ö</button>
      </div>
    </div>`;
  }).join("");

  box.innerHTML = html;
  totalBox.textContent = total.toFixed(0);
}

function setPicked(time){
  pickedTime = time;
  document.getElementById("picked").textContent = time || "-";
}

function loadSlots(){
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  setPicked(null);

  const slotsBox = document.getElementById("slots");
  slotsBox.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";

  const urgent = !!document.getElementById("urgent_toggle")?.checked;
  const tech_type = urgent ? "partner" : "company";

  // 1) compute duration (server-side) -> 2) load availability_v2
  const payload = buildDurationPayload();
  if(!payload) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á");

  fetch(`${API}/public/compute-duration`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(async r=>{
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return data;
  })
  .then(dur=>{
    const duration_min = Number(dur.duration_min||0);
    return fetch(`${API}/public/availability_v2?date=${encodeURIComponent(d)}&tech_type=${encodeURIComponent(tech_type)}&duration_min=${encodeURIComponent(duration_min)}`)
      .then(r=>r.json());
  })
  .then(data=>{
    if(data.error) throw new Error(data.error);
    if(!data.slots || !data.slots.length){
      slotsBox.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
      return;
    }
    const html = data.slots.map(s=>{
      const disabled = s.available ? "" : "disabled";
      const cls = s.available ? "" : "secondary";
      const label = `${s.start} - ${s.end}`;
      return `<button type="button" class="${cls}" style="width:auto;min-height:40px;margin:4px;" ${disabled}
                  onclick="setPicked('${s.start}')">${label}</button>`;
    }).join("");

    slotsBox.innerHTML = `<div class="muted">‡∏ä‡πà‡∏≤‡∏á${tech_type==='company'?'‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó':'‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ô‡∏≠‡∏£‡πå'}: ${data.tech_type} | Travel buffer: ${data.travel_buffer_min} ‡∏ô‡∏≤‡∏ó‡∏µ | Effective block: ${data.effective_block_min} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                          <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;">${html}</div>`;
  })
  .catch(e=>{
    slotsBox.textContent = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    alert(e.message || "‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    console.error(e);
  });
}

function book(){
  const d = document.getElementById("date").value;
  if(!d) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
  if(!pickedTime) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô");

  const customer_name = document.getElementById("customer_name").value.trim();
  const customer_phone = document.getElementById("customer_phone").value.trim();
  const job_type = document.getElementById("job_type").value.trim();
  const address_text = document.getElementById("address_text").value.trim();
  const maps_url = document.getElementById("maps_url").value.trim();
  const customer_note = document.getElementById("customer_note").value.trim();

  if(!customer_name || !job_type || !address_text){
    return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏ä‡∏∑‡πà‡∏≠/‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô/‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà)");
  }

  const urgent = !!document.getElementById("urgent_toggle")?.checked;
  const booking_mode = urgent ? "urgent" : "scheduled";

  // combine date + time -> ISO-like string local (backend ‡∏à‡∏∞ normalize ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
  const appointment_datetime = `${d}T${pickedTime}:00`;

  const durationPayload = buildDurationPayload() || {};

  fetch(`${API}/public/book`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      customer_name,
      customer_phone,
      job_type,
      appointment_datetime,
      address_text,
      maps_url,
      customer_note,
      items: jobItems.map(x=>({item_id:x.item_id, qty:x.qty})),
      booking_mode,
      job_category: durationPayload.job_category,
      ac_type: durationPayload.ac_type,
      wash_variant: durationPayload.wash_variant,
      repair_subtype: durationPayload.repair_subtype,
      machine_count: durationPayload.machine_count,
    })
  })
  .then(async r=>{
    const data = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(data.error || "‡∏à‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    return data;
  })
  .then(data=>{
    const box = document.getElementById("result");
    const token = data.token;
    box.innerHTML = `‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
      <b>‡πÄ‡∏•‡∏Ç Booking:</b> <span style="font-size:18px;">${data.booking_code || '-'}</span><br>
      <b>‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° (token):</b> <span style="font-size:14px;">${token}</span><br>
      <button type="button" class="secondary" style="width:auto;min-height:40px;margin-top:8px;"
        onclick="location.href='/track.html?q=${encodeURIComponent(data.booking_code || token)}'">üîé ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏á‡∏≤‡∏ô</button>`;
  })
  .catch(e=>{
    alert(`‚ùå ${e.message}`);
  });
}
</script>
</body>
</html>
