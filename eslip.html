<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CWF - ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* =====================================================
       üßæ E-Slip (Standard View)
       -----------------------------------------------------
       ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô "‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
       ‚úÖ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å /docs/receipt/:job_id)
       ‚úÖ ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤
       ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö field ‡πÉ‡∏î ‡πÜ ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
       ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ API/Controller/DB ‡πÉ‡∏î ‡πÜ
       -----------------------------------------------------
       ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß/‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° requirement 100%
       ===================================================== */

    .page{ max-width: 520px; margin: 0 auto; padding: 12px; }

    /* ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */
    .eslip{
      background:#ffffff;
      border:1px solid rgba(15,23,42,0.10);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(2,6,23,0.08);
    }
    .eslip-head{ text-align:center; }
    .eslip-head .h1{ font-weight:900; font-size:18px; }
    .eslip-head .h2{ margin-top:4px; font-weight:800; font-size:14px; color:#0f172a; }

    .eslip-logo{ width: min(220px, 55vw); height:auto; max-height:96px; object-fit:contain; display:block; margin:0 auto 8px; }

    .eslip-meta{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .eslip-meta .box{ padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:rgba(37,99,235,0.04); }

    .eslip-table{ width:100%; border-collapse:collapse; margin-top:12px; }
    .eslip-table th,.eslip-table td{ border:1px solid rgba(15,23,42,0.10); padding:8px; font-size:13px; }
    .eslip-table th{ background: rgba(37,99,235,0.08); text-align:left; }

    .eslip-sum{ margin-top:10px; padding:10px 12px; border:1px solid rgba(15,23,42,0.10); border-radius:12px; background:#fff; }
    .eslip-sum .row{ display:flex; justify-content:space-between; gap:10px; margin:6px 0; }
    .eslip-sum .total{ font-size:18px; font-weight:900; }

    .eslip-foot{ margin-top:12px; text-align:center; color:#475569; font-size:12.5px; line-height:1.45; }

    /* ‡∏õ‡∏∏‡πà‡∏°/‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° */
    .top-actions{ display:flex; gap:10px; justify-content:flex-end; margin: 6px 0 12px; }
    .top-actions button{ width:auto; }

    /* ‡∏û‡∏¥‡∏°‡∏û‡πå */
    @media print{
      .top-actions{ display:none !important; }
      body{ background:#fff; }
      .page{ max-width: none; padding: 0; }
      .eslip{ box-shadow:none; border: none; border-radius: 0; }
    }
  </style>
</head>

<body class="theme-2">
  <div class="page">
    <div class="top-actions">
      <button class="secondary" type="button" onclick="window.close()">‡∏õ‡∏¥‡∏î</button>
      <button type="button" onclick="window.print()">‡∏û‡∏¥‡∏°‡∏û‡πå</button>
    </div>

    <div class="eslip" id="doc">
      <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip...</div>
    </div>
  </div>

<script>
  const API = window.location.origin;

  // ==============================
  // üîí Helper: escape HTML
  // ==============================
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    }[m]));
  }

  // ==============================
  // üîé Read query string
  // ==============================
  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  // ==============================
  // üßæ Parse receipt HTML (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)
  // - ‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ + ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î
  // - ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏á‡∏≤‡∏ô ‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à
  // ==============================
  function parseReceiptHtml(html){
    const doc = new DOMParser().parseFromString(html, "text/html");

    // 1) rows (‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
    const table = doc.querySelector("table");
    const rows = Array.from(table?.querySelectorAll("tbody tr") || []).map(tr => {
      const tds = Array.from(tr.querySelectorAll("td")).map(td => (td.textContent || "").trim());
      return {
        name: tds[0] || "-",
        qty: tds[1] || "-",
        unit: tds[2] || "-",
        line: tds[3] || "-",
      };
    });

    // 2) summary (‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î / ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î / ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥)
    const boxes = Array.from(doc.querySelectorAll(".box"));
    const sumBox = boxes.find(b => (b.textContent || "").includes("‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥")) || null;
    const sumText = (sumBox?.textContent || "").replace(/\s+/g," ").trim();

    const subtotal = (sumText.match(/‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const discount = (sumText.match(/‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:\s*([0-9,\.]+)/) || [])[1] || "-";
    const total = (sumText.match(/‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:\s*([0-9,\.]+)/) || [])[1] || "-";

    // 3) booking (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ CWF ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°)
    const allText = (doc.body?.textContent || "").replace(/\s+/g," ").trim();
    const bookingMatch = allText.match(/\bCWF[A-Z0-9]{6,}\b/);
    const booking = bookingMatch ? bookingMatch[0] : "-";

    return {
      booking,
      rows: rows.length ? rows : [{name:"-",qty:"-",unit:"-",line:"-"}],
      subtotal,
      discount,
      total
    };
  }

  // ==============================
  // üßæ Render E-Receipt (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏≤‡∏° requirement 100%)
  // ==============================
  function renderESlip(data){
    const printedAt = new Date().toLocaleString("th-TH");
    const mount = document.getElementById("doc");

    mount.innerHTML = `
      <div class="eslip-head">
        <img class="eslip-logo" src="/logo.png" alt="Coldwindflow Air Services">
        <div class="h1">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå (E-Receipt)</div>
        <div class="h2">Coldwindflow Air Services</div>
      </div>

      <div class="eslip-meta">
        <div class="box"><b>Booking:</b> ${esc(data.booking || "-")}</div>
        <div class="box"><b>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•:</b> ${esc(printedAt)}</div>
      </div>

      <div style="margin-top:10px;">
        <div><b>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</b> ${esc(data.meta.customerName || "-")}</div>
        <div><b>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</b> ${esc(data.meta.customerPhone || "-")}</div>
        <div><b>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:</b> ${esc(data.meta.jobType || "-")}</div>
        <div><b>‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢:</b> ${esc(data.meta.appointment || "-")}</div>
        <div><b>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</b> ${esc(data.meta.address || "-")}</div>
      </div>

      <table class="eslip-table" aria-label="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤">
        <thead>
          <tr>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th style="text-align:right;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
            <th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
            <th style="text-align:right;">‡∏£‡∏ß‡∏°</th>
          </tr>
        </thead>
        <tbody>
          ${data.rows.map(it => `
            <tr>
              <td>${esc(it.name)}</td>
              <td style="text-align:right;">${esc(it.qty)}</td>
              <td style="text-align:right;">${esc(it.unit)}</td>
              <td style="text-align:right;">${esc(it.line)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>

      <div class="eslip-sum">
        <div class="row"><span>‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</span><b>${esc(data.subtotal)}</b></div>
        <div class="row"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</span><b>${esc(data.discount)}</b></div>
        <div class="row total"><span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span>${esc(data.total)}</span></div>
      </div>

      <div class="eslip-foot">
        ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô<br>
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡πÑ‡∏î‡πâ<br>
        ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°
      </div>
    `;
  }

  // ==============================
  // üöÄ Main
  // ==============================
  (async function main(){
    const jobId = Number(qs("job_id") || qs("id") || 0);
    const q = String(qs("q") || "").trim(); // booking/token (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    const mount = document.getElementById("doc");

    if (!jobId){
      mount.innerHTML = `<div class="muted">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö job_id ‡πÉ‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå</div>`;
      return;
    }

    // ‚úÖ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "meta" ‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: /public/track (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ backend)
    // - ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ meta ‡∏ã‡πâ‡∏≥/‡∏°‡∏±‡πà‡∏ß‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ parse ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß
    let meta = {
      customerName: "-",
      customerPhone: "-",
      jobType: "-",
      appointment: "-",
      address: "-"
    };
    let bookingFromTrack = "";

    if (q){
      try{
        const tr = await fetch(`${API}/public/track?q=${encodeURIComponent(q)}`, { cache:"no-store" });
        const td = await tr.json().catch(()=> ({}));
        if (tr.ok && td){
          bookingFromTrack = String(td.booking_code || td.booking || "").trim();
          meta.customerName = td.customer_name || "-";
          meta.customerPhone = td.customer_phone || "-";
          meta.jobType = td.job_type || "-";
          meta.appointment = td.appointment_datetime ? new Date(td.appointment_datetime).toLocaleString("th-TH") : "-";
          meta.address = td.address_text || "-";
        }
      }catch(e){
        // ‡∏ñ‡πâ‡∏≤ public/track ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ parse ‡∏à‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
      }
    }

    // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° (receipt) ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£/‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤
    const receiptUrl = `${API}/docs/receipt/${encodeURIComponent(jobId)}`;

    try{
      const r = await fetch(receiptUrl, { cache: "no-store", credentials: "include" });
      const html = await r.text();
      if (!r.ok) throw new Error("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

      const parsed = parseReceiptHtml(html);

      // ‡∏ñ‡πâ‡∏≤ meta ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô public/track ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ) ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse ‡πÅ‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
      if ((!q) || (meta.customerName === "-" && meta.customerPhone === "-" && meta.address === "-")){
        const text = (new DOMParser().parseFromString(html, "text/html").body?.textContent || "").replace(/\s+/g," ").trim();
        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö label ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏•‡∏ã‡πâ‡∏≥)
        const labels = ["‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:", "‡πÇ‡∏ó‡∏£:", "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:", "‡∏ô‡∏±‡∏î:", "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:"];
        const between = (label) => {
          const start = text.indexOf(label);
          if (start < 0) return "-";
          const from = start + label.length;
          let end = text.length;
          for (const l of labels){
            if (l === label) continue;
            const idx = text.indexOf(l, from);
            if (idx >= 0 && idx < end) end = idx;
          }
          return text.slice(from, end).trim() || "-";
        };
        meta.customerName = between("‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:");
        meta.customerPhone = between("‡πÇ‡∏ó‡∏£:");
        meta.jobType = between("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô:");
        meta.appointment = between("‡∏ô‡∏±‡∏î:");
        meta.address = between("‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:");
      }

      // booking: ‡πÉ‡∏´‡πâ‡∏¢‡∏∂‡∏î booking ‡∏à‡∏≤‡∏Å track ‡∏Å‡πà‡∏≠‡∏ô > query q > parsed
      const bookingFinal = bookingFromTrack || q || parsed.booking || "-";

      renderESlip({
        booking: bookingFinal,
        rows: parsed.rows,
        subtotal: parsed.subtotal,
        discount: parsed.discount,
        total: parsed.total,
        meta
      });
    }catch(e){
      mount.innerHTML = `<div class="muted">‚ùå ‡∏™‡∏£‡πâ‡∏≤‡∏á E-Slip ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${esc(e.message || e)}</div>`;
    }
  })();
</script>
</body>
</html>
